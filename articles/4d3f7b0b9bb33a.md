---
title: "iPhoneã¨AppleWatché–“ã§Workoutã‚’åŒæœŸã™ã‚‹"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [iOS,Swift,SwiftUI,HealthKit]
published: true
---

![](/images/2024-06-15-05-59-47.png)

## HealthKitã®APIã‚’æ´»ç”¨ã—ãŸãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åŒæœŸ

AppleWatchã¨iPhoneé–“ã§ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åŒæœŸã™ã‚‹æ–¹æ³•ã«ç„¦ç‚¹ã‚’å½“ã¦ã€è©³ç´°ã«èª¬æ˜ã—ã¾ã™ã€‚ã“ã®APIã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€AppleWatchã§å®Ÿè¡Œä¸­ã®ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚’iPhoneã«åŒæœŸã—ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºãƒ»åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»Šå›ã¯Workoutã«é–¢ã—ã¦ã®è©³ç´°ã¯è¨˜è¼‰ã—ã¾ã›ã‚“ã€‚Workoutã«é–¢ã—ã¦ã¯éå»ã«è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸã®ã§ã€å‚è€ƒã¾ã§ã«ã”è¦§ãã ã•ã„ã€‚

https://zenn.dev/muranaka/articles/2_e775b55b2e90ec

### ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ§‹æˆ

![](/images/2024-06-15-06-00-33.png)

ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã€AppleWatchã§é–‹å§‹ã•ã‚Œã€iPhoneã§å—ä¿¡ã•ã‚Œã¾ã™ã€‚

#### 1. ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹

AppleWatchã§ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™ã€‚ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã€ŒPrimary Sessionã€ã¨å‘¼ã°ã‚Œã€ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ï¼ˆé–‹å§‹ã€åœæ­¢ã€å†é–‹ãªã©ï¼‰ã‚’ç®¡ç†ã—ã¾ã™ã€‚

#### 2. ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ã®é–‹å§‹

AppleWatchã§PrimarySessionã‚’é–‹å§‹ã—ãŸå¾Œã€[`startMirroringToCompanionDevice`](https://developer.apple.com/documentation/healthkit/hkworkoutsession/4165515-startmirroringtocompaniondevice)ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦åŒæœŸã‚’é–‹å§‹ã—ã¾ã™ã€‚ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã‚Šã€iPhoneã‚¢ãƒ—ãƒªãŒãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•ã•ã‚Œã€ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚

```swift
try await session?.startMirroringToCompanionDevice()
```

#### 3. ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ã®é–‹å§‹ã‚’æ¤œçŸ¥ã™ã‚‹

iPhoneã‚¢ãƒ—ãƒªã§ã¯ã€ã‚¢ãƒ—ãƒªã®èµ·å‹•ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã§ãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®šã—ã¦ã€HealthStoreã‚’ä½¿ç”¨ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å—ã‘å–ã‚‹æº–å‚™ã‚’ã—ã¾ã™ã€‚

```swift
healthStore.workoutSessionMirroringStartHandler = { mirroredSession in
    Task { @MainActor in
        Logger.shared.log("ãƒªãƒ¢ãƒ¼ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ã‚’é–‹å§‹: \(mirroredSession)")
    }
}
```

#### 4. ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åŒæœŸ

![](/images/2024-06-15-06-03-31.png)

Apple Watchã¨iPhoneã®ä¸¡æ–¹ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’ç›£è¦–ã™ã‚‹ãŸã‚ã«ã€ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚

![](/images/2024-06-15-06-04-16.png)

ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã«ã‚ˆã‚Šã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹å¤‰æ›´ï¼ˆé–‹å§‹ã€åœæ­¢ã€å†é–‹ãªã©ï¼‰ãŒä¸¡ãƒ‡ãƒã‚¤ã‚¹ã§åŒæœŸã•ã‚Œã¾ã™ã€‚ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã®å®Ÿè£…æ–¹æ³•ã«é–¢ã—ã¦ã¯ã€[ã“ã¡ã‚‰ã®è¨˜äº‹](https://zenn.dev/muranaka/articles/2_e775b55b2e90ec)ã‚’ã”è¦§ãã ã•ã„ã€‚

### ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ä¸­ã®ãƒ‡ãƒ¼ã‚¿äº¤æ›

HealthKitã¯ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³é–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘æ¸¡ã—ãŒå¯èƒ½ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åŒæœŸã§ãã¾ã™ã€‚

#### ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡

AppleWatchã‹ã‚‰iPhoneã¸ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã¯ã€[`sendToRemoteWorkoutSession(data:completion:)`](https://developer.apple.com/documentation/healthkit/hkworkoutsession/4126899-sendtoremoteworkoutsession)ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã®å–å¾—ã¯ã€[`HKLiveWorkoutBuilderDelegate`](https://developer.apple.com/documentation/healthkit/hkliveworkoutbuilderdelegate)ã®[`workoutBuilder(_:didCollectDataOf:)`](https://developer.apple.com/documentation/healthkit/hkliveworkoutbuilderdelegate/2962897-workoutbuilder)ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’æ¤œçŸ¥ã—é€ä¿¡ã—ã¾ã™ã€‚

```swift
extension WorkoutManager: HKLiveWorkoutBuilderDelegate {
    nonisolated func workoutBuilder(_ workoutBuilder: HKLiveWorkoutBuilder, didCollectDataOf collectedTypes: Set<HKSampleType>) {
        Task { @MainActor in
            // å‡¦ç†ã‚’çœç•¥ã€€Dataå‹ã«å¤‰æ›ã—ã¦é€ä¿¡ã™ã‚‹
            do {
                try await session?.sendToRemoteWorkoutSession(data: ...)
            } catch {
                Logger.shared.log("ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: \(error)")
            }
        }
    }
}
```

#### ãƒ‡ãƒ¼ã‚¿ã®å—ä¿¡

iPhoneå´ã§ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã™ã‚‹ã«ã¯ã€[`HKWorkoutSessionDelegate`](https://developer.apple.com/documentation/healthkit/hkworkoutsessiondelegate)ã®[`workoutSession(_:didReceiveDataFromRemoteWorkoutSession:)`](https://developer.apple.com/documentation/healthkit/hkworkoutsessiondelegate/4266951-workoutsession)ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€AppleWatchå´ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸ`Dataå‹`ã‚’ã€iPhoneå´ã§å—ã‘å–ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

```swift
extension WorkoutManager: HKWorkoutSessionDelegate {
    nonisolated func workoutSession(_ workoutSession: HKWorkoutSession,
                                    didReceiveDataFromRemoteWorkoutSession data: [Data]) {
        Logger.shared.log("\(#function): \(data.debugDescription)")
        Task { @MainActor in
            do {
                for anElement in data {
                    try handleReceivedData(anElement)
                }
            } catch {
                Logger.shared.log("ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: \(error)")
            }
        }
    }
}
```

ä»Šå›ã®äº‹ä¾‹ã§ã¯AppleWatchã‹ã‚‰iPhoneã¸ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚’è¨˜è¼‰ã—ã¾ã™ãŒã€iPhoneã‹ã‚‰AppleWatchã¸ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚‚åŒæ§˜ã®å®Ÿè£…ã§å¯èƒ½ã§ã™ã€‚

### ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ã®åœæ­¢

ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ã‚’åœæ­¢ã™ã‚‹ã«ã¯ã€[`stopMirroringToCompanionDevice(completion:)`](https://developer.apple.com/documentation/healthkit/hkworkoutsession/4165516-stopmirroringtocompaniondevice)ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

```swift
do {
    try await session.stopMirroringToCompanionDevice()
} catch {
    fatalError("*** ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã®åœæ­¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: \(error.localizedDescription) ***")
}
```

## ã¾ã¨ã‚

HealthKitã®ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°APIã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€Apple Watchã¨iPhoneé–“ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åŒæœŸã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’äº¤æ›ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚ˆã‚Šè‰¯ã„ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆä½“é¨“ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»¥ä¸ŠãŒã€HealthKitã®ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°APIã‚’æ´»ç”¨ã—ãŸãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åŒæœŸæ–¹æ³•ã§ã™ã€‚

## å‚è€ƒè³‡æ–™

https://developer.apple.com/videos/play/wwdc2023/10023/