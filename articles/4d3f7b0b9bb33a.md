---
title: "Workoutの端末間での同期"
emoji: "🏃"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [iOS,Swift,SwiftUI,HealthKit]
published: false
---

![](/images/2024-06-15-05-59-47.png)

## HealthKitのミラーリングAPIを活用したワークアウトセッションの同期

Apple WatchとiPhone間でワークアウトセッションを同期する方法に焦点を当て、詳細に説明します。このAPIを使用することで、Apple Watchで実行中のワークアウトをiPhoneに同期し、リアルタイムでデータを表示・制御することができます。

### ワークアウトセッションの構成

ミラーリングセッションは、AppleWatchで開始され、iPhoneで受信されます。以下は、その具体的な手順です。

#### 1. ワークアウトセッションの開始

AppleWatchでワークアウトセッションを開始します。このセッションは「プライマリセッション」と呼ばれ、ワークアウトのライフサイクル（開始、停止、再開など）を管理します。

#### 2. ミラーリングの開始

AppleWatchでプライマリセッションを開始した後、`startMirroringToCompanionDevice`メソッドを呼び出して同期を開始します。このメソッドにより、iPhoneアプリがバックグラウンドで起動され、ワークアウトセッションが渡されます。

https://developer.apple.com/documentation/healthkit/hkworkoutsession/4165515-startmirroringtocompaniondevice

#### 3. iPhoneアプリの設定

iPhoneアプリでは、アプリの起動シーケンスでハンドラを設定して、HealthStoreを使用してセッションを受け取る準備をします。以下は、具体的なコード例です。

```swift
import HealthKit

let healthStore = HKHealthStore()

func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
    // ミラーリングセッションを受け取るためのハンドラを設定
    healthStore.handleAuthorizationForExtension { (success, error) in
        if success {
            // ハンドラの設定
            self.setupMirroringHandler()
        }
    }
    return true
}

func setupMirroringHandler() {
    healthStore.startMirroringToCompanionDevice { (session, error) in
        if let session = session {
            // ミラーリングセッションを受け取ったときの処理
            self.handleReceivedSession(session)
        }
    }
}

func handleReceivedSession(_ session: HKWorkoutSession) {
    // ミラーリングセッションの処理
}
```

#### 4. セッション状態の同期

Apple WatchとiPhoneの両方でセッションの状態を監視するために、デリゲートを設定します。これにより、セッションの状態変更（開始、停止、再開など）が両デバイスで同期されます。

```swift
// Apple Watch側のデリゲート設定
workoutSession.delegate = self

// iPhone側のデリゲート設定
mirroredSession.delegate = self

extension ViewController: HKWorkoutSessionDelegate {
    func workoutSession(_ workoutSession: HKWorkoutSession, didChangeTo toState: HKWorkoutSessionState, from fromState: HKWorkoutSessionState, date: Date) {
        // セッション状態の変更を処理
        if toState == .running {
            // セッションが開始された
        } else if toState == .paused {
            // セッションが一時停止された
        }
    }
}
```

### ミラーリング中のデータ交換

HealthKitは、ミラーリングセッション間でデータを交換も可能です。これにより、ワークアウトデータやイベントをリアルタイムで同期できます。

#### データの送信

Apple WatchからiPhoneへのデータ送信は、`sendData(toRemoteWorkoutSession:)`メソッドを使用します。例えば、サイクリング中の速度やケイデンスデータを送信する場合、以下のように実装します。

```swift
func sendCyclingData(speed: Double, cadence: Double) {
    let data = ["speed": speed, "cadence": cadence]
    do {
        let jsonData = try JSONSerialization.data(withJSONObject: data, options: [])
        try primarySession.sendData(toRemoteWorkoutSession: jsonData)
    } catch {
        print("データ送信エラー: \(error)")
    }
}
```

#### データの受信
iPhone側でデータを受信するには、デリゲートメソッドを実装します。

```swift
func workoutSession(_ workoutSession: HKWorkoutSession, didReceive data: Data) {
    do {
        if let receivedData = try JSONSerialization.jsonObject(with: data, options: []) as? [String: Double] {
            let speed = receivedData["speed"]
            let cadence = receivedData["cadence"]
            // 受信したデータを処理
        }
    } catch {
        print("データ受信エラー: \(error)")
    }
}
```

### ミラーリングの停止

ワークアウトセッションのミラーリングを停止するには、`stopMirroringToCompanionDevice`メソッドを呼び出します。

```swift
func stopMirroringSession() {
    primarySession.stopMirroringToCompanionDevice()
}
```

## まとめ

HealthKitのミラーリングAPIを使用することで、Apple WatchとiPhone間でリアルタイムにワークアウトセッションを同期し、データを交換することが可能になります。ユーザーはよりリッチなワークアウト体験を得ることができます。以上が、HealthKitのミラーリングAPIを活用したワークアウトセッションの同期方法の詳細です。

## 参考資料

https://developer.apple.com/videos/play/wwdc2023/10023/

![](/images/2024-06-15-06-00-33.png)

![](/images/2024-06-15-06-00-57.png)

![](/images/2024-06-15-06-01-20.png)

![](/images/2024-06-15-06-01-45.png)

![](/images/2024-06-15-06-02-03.png)

![](/images/2024-06-15-05-59-47.png)

![](/images/2024-06-15-06-02-54.png)

![](/images/2024-06-15-06-03-07.png)

![](/images/2024-06-15-06-03-31.png)

![](/images/2024-06-15-06-03-44.png)

![](/images/2024-06-15-06-04-16.png)

![](/images/2024-06-15-06-04-30.png)

![](/images/2024-06-15-06-04-54.png)

![](/images/2024-06-15-06-05-09.png)

![](/images/2024-06-15-06-05-37.png)

![](/images/2024-06-15-06-05-48.png)

![](/images/2024-06-15-06-06-31.png)

![](/images/2024-06-15-06-06-54.png)

![](/images/2024-06-15-06-07-07.png)

![](/images/2024-06-15-06-07-26.png)

![](/images/2024-06-15-06-07-36.png)

![](/images/2024-06-15-06-08-47.png)

![](/images/2024-06-15-06-09-13.png)

![](/images/2024-06-15-06-09-25.png)

