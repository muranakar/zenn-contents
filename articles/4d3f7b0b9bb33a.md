---
title: "Workoutã®ç«¯æœ«é–“ã§ã®åŒæœŸ"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [iOS,Swift,SwiftUI,HealthKit]
published: false
---

![](/images/2024-06-15-05-59-47.png)

## HealthKitã®ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°APIã‚’æ´»ç”¨ã—ãŸãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åŒæœŸ

Apple Watchã¨iPhoneé–“ã§ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åŒæœŸã™ã‚‹æ–¹æ³•ã«ç„¦ç‚¹ã‚’å½“ã¦ã€è©³ç´°ã«èª¬æ˜ã—ã¾ã™ã€‚ã“ã®APIã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€Apple Watchã§å®Ÿè¡Œä¸­ã®ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚’iPhoneã«åŒæœŸã—ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºãƒ»åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ§‹æˆ

ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã€AppleWatchã§é–‹å§‹ã•ã‚Œã€iPhoneã§å—ä¿¡ã•ã‚Œã¾ã™ã€‚ä»¥ä¸‹ã¯ã€ãã®å…·ä½“çš„ãªæ‰‹é †ã§ã™ã€‚

#### 1. ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹

AppleWatchã§ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™ã€‚ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã€Œãƒ—ãƒ©ã‚¤ãƒãƒªã‚»ãƒƒã‚·ãƒ§ãƒ³ã€ã¨å‘¼ã°ã‚Œã€ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ï¼ˆé–‹å§‹ã€åœæ­¢ã€å†é–‹ãªã©ï¼‰ã‚’ç®¡ç†ã—ã¾ã™ã€‚

#### 2. ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ã®é–‹å§‹

AppleWatchã§ãƒ—ãƒ©ã‚¤ãƒãƒªã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ãŸå¾Œã€`startMirroringToCompanionDevice`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦åŒæœŸã‚’é–‹å§‹ã—ã¾ã™ã€‚ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã‚Šã€iPhoneã‚¢ãƒ—ãƒªãŒãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•ã•ã‚Œã€ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚

https://developer.apple.com/documentation/healthkit/hkworkoutsession/4165515-startmirroringtocompaniondevice

#### 3. iPhoneã‚¢ãƒ—ãƒªã®è¨­å®š

iPhoneã‚¢ãƒ—ãƒªã§ã¯ã€ã‚¢ãƒ—ãƒªã®èµ·å‹•ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã§ãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®šã—ã¦ã€HealthStoreã‚’ä½¿ç”¨ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å—ã‘å–ã‚‹æº–å‚™ã‚’ã—ã¾ã™ã€‚ä»¥ä¸‹ã¯ã€å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ä¾‹ã§ã™ã€‚

```swift
import HealthKit

let healthStore = HKHealthStore()

func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
    // ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å—ã‘å–ã‚‹ãŸã‚ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
    healthStore.handleAuthorizationForExtension { (success, error) in
        if success {
            // ãƒãƒ³ãƒ‰ãƒ©ã®è¨­å®š
            self.setupMirroringHandler()
        }
    }
    return true
}

func setupMirroringHandler() {
    healthStore.startMirroringToCompanionDevice { (session, error) in
        if let session = session {
            // ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å—ã‘å–ã£ãŸã¨ãã®å‡¦ç†
            self.handleReceivedSession(session)
        }
    }
}

func handleReceivedSession(_ session: HKWorkoutSession) {
    // ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‡¦ç†
}
```

#### 4. ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åŒæœŸ

Apple Watchã¨iPhoneã®ä¸¡æ–¹ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’ç›£è¦–ã™ã‚‹ãŸã‚ã«ã€ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹å¤‰æ›´ï¼ˆé–‹å§‹ã€åœæ­¢ã€å†é–‹ãªã©ï¼‰ãŒä¸¡ãƒ‡ãƒã‚¤ã‚¹ã§åŒæœŸã•ã‚Œã¾ã™ã€‚

```swift
// Apple Watchå´ã®ãƒ‡ãƒªã‚²ãƒ¼ãƒˆè¨­å®š
workoutSession.delegate = self

// iPhoneå´ã®ãƒ‡ãƒªã‚²ãƒ¼ãƒˆè¨­å®š
mirroredSession.delegate = self

extension ViewController: HKWorkoutSessionDelegate {
    func workoutSession(_ workoutSession: HKWorkoutSession, didChangeTo toState: HKWorkoutSessionState, from fromState: HKWorkoutSessionState, date: Date) {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®å¤‰æ›´ã‚’å‡¦ç†
        if toState == .running {
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚ŒãŸ
        } else if toState == .paused {
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä¸€æ™‚åœæ­¢ã•ã‚ŒãŸ
        }
    }
}
```

### ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ä¸­ã®ãƒ‡ãƒ¼ã‚¿äº¤æ›

HealthKitã¯ã€ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³é–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’äº¤æ›ã‚‚å¯èƒ½ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åŒæœŸã§ãã¾ã™ã€‚

#### ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡

Apple Watchã‹ã‚‰iPhoneã¸ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã¯ã€`sendData(toRemoteWorkoutSession:)`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°ä¸­ã®é€Ÿåº¦ã‚„ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚

```swift
func sendCyclingData(speed: Double, cadence: Double) {
    let data = ["speed": speed, "cadence": cadence]
    do {
        let jsonData = try JSONSerialization.data(withJSONObject: data, options: [])
        try primarySession.sendData(toRemoteWorkoutSession: jsonData)
    } catch {
        print("ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚¨ãƒ©ãƒ¼: \(error)")
    }
}
```

#### ãƒ‡ãƒ¼ã‚¿ã®å—ä¿¡
iPhoneå´ã§ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã™ã‚‹ã«ã¯ã€ãƒ‡ãƒªã‚²ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```swift
func workoutSession(_ workoutSession: HKWorkoutSession, didReceive data: Data) {
    do {
        if let receivedData = try JSONSerialization.jsonObject(with: data, options: []) as? [String: Double] {
            let speed = receivedData["speed"]
            let cadence = receivedData["cadence"]
            // å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
        }
    } catch {
        print("ãƒ‡ãƒ¼ã‚¿å—ä¿¡ã‚¨ãƒ©ãƒ¼: \(error)")
    }
}
```

### ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ã®åœæ­¢

ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ã‚’åœæ­¢ã™ã‚‹ã«ã¯ã€`stopMirroringToCompanionDevice`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

```swift
func stopMirroringSession() {
    primarySession.stopMirroringToCompanionDevice()
}
```

## ã¾ã¨ã‚

HealthKitã®ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°APIã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€Apple Watchã¨iPhoneé–“ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åŒæœŸã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’äº¤æ›ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚ˆã‚Šãƒªãƒƒãƒãªãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆä½“é¨“ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»¥ä¸ŠãŒã€HealthKitã®ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°APIã‚’æ´»ç”¨ã—ãŸãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åŒæœŸæ–¹æ³•ã®è©³ç´°ã§ã™ã€‚

## å‚è€ƒè³‡æ–™

https://developer.apple.com/videos/play/wwdc2023/10023/

![](/images/2024-06-15-06-00-33.png)

![](/images/2024-06-15-06-00-57.png)

![](/images/2024-06-15-06-01-20.png)

![](/images/2024-06-15-06-01-45.png)

![](/images/2024-06-15-06-02-03.png)

![](/images/2024-06-15-05-59-47.png)

![](/images/2024-06-15-06-02-54.png)

![](/images/2024-06-15-06-03-07.png)

![](/images/2024-06-15-06-03-31.png)

![](/images/2024-06-15-06-03-44.png)

![](/images/2024-06-15-06-04-16.png)

![](/images/2024-06-15-06-04-30.png)

![](/images/2024-06-15-06-04-54.png)

![](/images/2024-06-15-06-05-09.png)

![](/images/2024-06-15-06-05-37.png)

![](/images/2024-06-15-06-05-48.png)

![](/images/2024-06-15-06-06-31.png)

![](/images/2024-06-15-06-06-54.png)

![](/images/2024-06-15-06-07-07.png)

![](/images/2024-06-15-06-07-26.png)

![](/images/2024-06-15-06-07-36.png)

![](/images/2024-06-15-06-08-47.png)

![](/images/2024-06-15-06-09-13.png)

![](/images/2024-06-15-06-09-25.png)

