---
title: "ã€Flutterã€‘Laravel TODOã‚¢ãƒ—ãƒªã®APIã¨ã®é€£æº"
emoji: "ğŸ‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Laravel, PHP, PostgreSQL]
published: false
---

## ã¯ã˜ã‚ã«

å‰å›ä½œæˆã—ãŸ Laravel TODO ãƒªã‚¹ãƒˆç®¡ç† API ã¨é€£æºã™ã‚‹ Flutter ã‚¢ãƒ—ãƒªã®å®Ÿè£…æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚API é€£æºã®éƒ¨åˆ†ã ã‘ã«çµã£ã¦è¨˜è¼‰ã™ã‚‹ãŸã‚ã€ä½™åˆ†ãªã‚³ãƒ¼ãƒ‰ã¯çœç•¥ã—ã¦ã„ã¾ã™ã€‚

ä»Šå›å®Ÿè£…ã—ãŸã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

https://github.com/muranakar/todo_laravel

## å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

ã¾ãšã€API é€£æºã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
flutter pub add dio freezed freezed_annotation json_annotation
flutter pub add --dev build_runner json_serializable
```

- **dio**: HTTP é€šä¿¡ç”¨ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
- **freezed**: ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹ç”Ÿæˆ
- **json_annotation**: JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º/ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º

## ãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…

API ã‹ã‚‰å—ã‘å–ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ Dart ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã™ã‚‹ãŸã‚ã®ãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

::: details å®Ÿè£…ä¾‹

```dart:lib/models/todo.dart
import 'package:freezed_annotation/freezed_annotation.dart';
import 'package:json_annotation/json_annotation.dart';

part 'todo.freezed.dart';
part 'todo.g.dart';

@freezed
class Todo with _$Todo {
  const factory Todo({
    required int id,
    required String title,
    String? description,
    @JsonKey(name: 'priority') required PriorityInfo priority,
    @JsonKey(name: 'due_date') String? dueDate,
    required bool completed,
    @JsonKey(name: 'is_overdue') required bool isOverdue,
    @JsonKey(name: 'created_at') required String createdAt,
    @JsonKey(name: 'updated_at') required String updatedAt,
  }) = _Todo;

  factory Todo.fromJson(Map<String, dynamic> json) => _$TodoFromJson(json);
}

@freezed
class PriorityInfo with _$PriorityInfo {
  const factory PriorityInfo({
    required int value,
    required String label,
  }) = _PriorityInfo;

  factory PriorityInfo.fromJson(Map<String, dynamic> json) => _$PriorityInfoFromJson(json);
}

// ãƒ‡ãƒ¼ã‚¿è»¢é€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
@freezed
class TodoCreateDto with _$TodoCreateDto {
  const factory TodoCreateDto({
    required String title,
    String? description,
    int? priority,
    @JsonKey(name: 'due_date') String? dueDate,
    bool? completed,
  }) = _TodoCreateDto;

  factory TodoCreateDto.fromJson(Map<String, dynamic> json) => _$TodoCreateDtoFromJson(json);
}

@freezed
class TodoUpdateDto with _$TodoUpdateDto {
  const factory TodoUpdateDto({
    String? title,
    String? description,
    int? priority,
    @JsonKey(name: 'due_date') String? dueDate,
    bool? completed,
  }) = _TodoUpdateDto;

  factory TodoUpdateDto.fromJson(Map<String, dynamic> json) => _$TodoUpdateDtoFromJson(json);
}
```

:::

ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

```bash
flutter pub run build_runner build
```

## API ãƒªãƒã‚¸ãƒˆãƒªã®å®Ÿè£…

API ã¨ã®é€šä¿¡ã‚’è¡Œã†ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

::: details ã€€ä¾‹

```dart:lib/repositories/todo_repository.dart
import 'package:dio/dio.dart';
import '../models/todo.dart';

class TodoRepository {
  final String baseUrl = 'http://127.0.0.1:8000/api/v1';
  late final Dio _dio;

  TodoRepository() {
    _dio = Dio(BaseOptions(
      baseUrl: baseUrl,
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      },
      connectTimeout: const Duration(seconds: 5),
      receiveTimeout: const Duration(seconds: 3),
    ));

    _dio.interceptors.add(LogInterceptor(
      requestBody: true,
      responseBody: true,
    ));
  }

  // TODOãƒªã‚¹ãƒˆå–å¾—
  Future<List<Todo>> fetchTodos({
    bool? completed,
    int? priority,
    String? sortBy,
    String? sortDirection,
  }) async {
    try {
      final Map<String, dynamic> queryParams = {};
      if (completed != null) queryParams['completed'] = completed;
      if (priority != null) queryParams['priority'] = priority;
      if (sortBy != null) queryParams['sort_by'] = sortBy;
      if (sortDirection != null) queryParams['sort_direction'] = sortDirection;

      final response = await _dio.get('/todos', queryParameters: queryParams);
      final List<dynamic> data = response.data['data'];
      return data.map((json) => Todo.fromJson(json)).toList();
    } catch (e) {
      throw _handleError(e);
    }
  }

  // å˜ä¸€TODOå–å¾—
  Future<Todo> fetchTodo(int id) async {
    try {
      final response = await _dio.get('/todos/$id');
      return Todo.fromJson(response.data['data']);
    } catch (e) {
      throw _handleError(e);
    }
  }

  // TODOä½œæˆ
  Future<Todo> createTodo(TodoCreateDto todo) async {
    try {
      final response = await _dio.post(
        '/todos',
        data: todo.toJson(),
      );
      return Todo.fromJson(response.data['data']);
    } catch (e) {
      throw _handleError(e);
    }
  }

  // TODOæ›´æ–°
  Future<Todo> updateTodo(int id, TodoUpdateDto todo) async {
    try {
      final response = await _dio.put(
        '/todos/$id',
        data: todo.toJson(),
      );
      return Todo.fromJson(response.data['data']);
    } catch (e) {
      throw _handleError(e);
    }
  }

  // TODOå‰Šé™¤
  Future<void> deleteTodo(int id) async {
    try {
      await _dio.delete('/todos/$id');
    } catch (e) {
      throw _handleError(e);
    }
  }

  // å®Œäº†çŠ¶æ…‹åˆ‡ã‚Šæ›¿ãˆ
  Future<Todo> toggleComplete(int id) async {
    try {
      final response = await _dio.patch('/todos/$id/toggle-complete');
      return Todo.fromJson(response.data['data']);
    } catch (e) {
      throw _handleError(e);
    }
  }

  // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  Exception _handleError(dynamic error) {
    if (error is DioException) {
      if (error.response != null) {
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼å‡¦ç†
        if (error.response?.statusCode == 422 &&
            error.response?.data['errors'] != null) {
          final errorMessages = error.response?.data['errors'].entries
              .map((e) => '${e.key}: ${e.value.join(', ')}')
              .join('\n');
          return Exception('å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼:\n$errorMessages');
        }
        return Exception(
            'APIã‚¨ãƒ©ãƒ¼: ${error.response?.statusCode} ${error.response?.statusMessage}');
      } else if (error.type == DioExceptionType.connectionTimeout) {
        return Exception('æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ');
      } else if (error.type == DioExceptionType.receiveTimeout) {
        return Exception('å—ä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒé…ã™ãã¾ã™');
      } else if (error.type == DioExceptionType.connectionError) {
        return Exception('æ¥ç¶šã‚¨ãƒ©ãƒ¼: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
      }
      return Exception('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}');
    }
    return Exception('ä¸æ˜ãªã‚¨ãƒ©ãƒ¼: $error');
  }
}
```

:::

## API å‘¼ã³å‡ºã—è§£èª¬

### 1. ãƒªãƒã‚¸ãƒˆãƒªã®åˆæœŸåŒ–

```dart
final repository = TodoRepository();
```

### 2. TODO ãƒªã‚¹ãƒˆã®å–å¾—

```dart
// å…¨ã¦ã®TODOã‚’å–å¾—
final todos = await repository.fetchTodos();

// æœªå®Œäº†ã®TODOã®ã¿å–å¾—
final pendingTodos = await repository.fetchTodos(completed: false);

// å„ªå…ˆåº¦é«˜ã®TODOã‚’æœŸé™æ—¥é †ã§å–å¾—
final highPriorityTodos = await repository.fetchTodos(
  priority: 3,
  sortBy: 'due_date',
  sortDirection: 'asc',
);
```

::: details ç´°ã‹ã„å‘¼ã³å‡ºã—

### 3. TODO è©³ç´°ã®å–å¾—

```dart
// IDæŒ‡å®šã§TODOã‚’å–å¾—
final todo = await repository.fetchTodo(1);
print('å–å¾—ã—ãŸTODO: ${todo.title}, å„ªå…ˆåº¦: ${todo.priority.label}');
```

### 4. æ–°è¦ TODO ã®ä½œæˆ

```dart
// æ–°è¦TODOä½œæˆ
final newTodo = TodoCreateDto(
  title: 'Flutterã‚¢ãƒ—ãƒªé–‹ç™º',
  description: 'TODOãƒªã‚¹ãƒˆã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹',
  priority: 2,
  dueDate: '2025-04-10',
);

final createdTodo = await repository.createTodo(newTodo);
print('ä½œæˆã•ã‚ŒãŸTODO ID: ${createdTodo.id}');
```

### 5. TODO ã®æ›´æ–°

```dart
// æ—¢å­˜TODOã®æ›´æ–°
final todoUpdate = TodoUpdateDto(
  title: 'ä¿®æ­£:Flutterã‚¢ãƒ—ãƒªé–‹ç™º',
  priority: 3,
  dueDate: '2025-04-05',
);

final updatedTodo = await repository.updateTodo(1, todoUpdate);
print('æ›´æ–°ã•ã‚ŒãŸTODO: ${updatedTodo.title}');
```

### 6. å®Œäº†çŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆ

```dart
// å®Œäº†çŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆ
final toggledTodo = await repository.toggleComplete(1);
print('å®Œäº†çŠ¶æ…‹: ${toggledTodo.completed ? "å®Œäº†" : "æœªå®Œäº†"}');
```

### 7. TODO ã®å‰Šé™¤

```dart
// TODOã®å‰Šé™¤
await repository.deleteTodo(1);
print('TODOã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
```

### 8. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```dart
try {
  final todos = await repository.fetchTodos();
  // æˆåŠŸå‡¦ç†
} catch (e) {
  print('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: $e');
  // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚„ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
}
```

:::

## å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ

### 1. API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š

```dart
_dio = Dio(BaseOptions(
  baseUrl: baseUrl,
  headers: {
    'Content-Type': 'application/json',
    'Accept': 'application/json',
  },
  connectTimeout: const Duration(seconds: 5),
  receiveTimeout: const Duration(seconds: 3),
));
```

- **ãƒ™ãƒ¼ã‚¹ URL**: `127.0.0.1`ã¾ãŸã¯`10.0.2.2`ã‚’ä½¿ç”¨
  iOS Android ã«ã‚ˆã£ã¦ã€å¤‰æ›´ã®å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
- **ãƒ˜ãƒƒãƒ€ãƒ¼**: JSON ãƒ‡ãƒ¼ã‚¿ã®é€å—ä¿¡ã‚’æŒ‡å®š
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: æ¥ç¶šé…å»¶å¯¾ç­–

### 2. ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¨­å®š

```dart
_dio.interceptors.add(LogInterceptor(
  requestBody: true,
  responseBody: true,
));
```

é–‹ç™ºä¸­ã«é€šä¿¡å†…å®¹ã‚’ç¢ºèªã§ãã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼ã‚’è¨­å®šã€‚

::: details ã€€é€šä¿¡å†…å®¹ã®è©³ç´°ãƒ­ã‚°

ä»¥ä¸‹ã®ã‚ˆã†ãªè©³ç´°ãªé€šä¿¡å†…å®¹ã®ãƒ­ã‚°ã‚’å‡ºåŠ›ãŒå¯èƒ½ã€‚ä¾¿åˆ©ã€‚

```
flutter: **_ Request _**
flutter: uri: http://127.0.0.1:8000/api/v1/todos
flutter: method: GET
flutter: responseType: ResponseType.json
flutter: followRedirects: true
flutter: persistentConnection: true
flutter: connectTimeout: 0:00:05.000000
flutter: sendTimeout: null
flutter: receiveTimeout: 0:00:03.000000
flutter: receiveDataWhenStatusError: true
flutter: extra: {}
flutter: headers:
flutter: Content-Type: application/json
flutter: Accept: application/json
flutter: data:
flutter: null
flutter:
flutter: **_ Response _**
flutter: uri: http://127.0.0.1:8000/api/v1/todos
flutter: statusCode: 200
flutter: headers:
flutter: connection: close
flutter: x-powered-by: PHP/8.4.4
flutter: cache-control: no-cache, private
flutter: date: Wed, 12 Mar 2025 07:35:38 GMT
flutter: access-control-allow-origin: \*
flutter: host: 127.0.0.1:8000
flutter: content-type: application/json
flutter: Response Text:
flutter: {"data":[{"id":14,"title":"a","description":"a","priority":{"value":1,"label":"ä½"},"due_date":null,"completed":false,"is_overdue":false,"created_at":"2025-03-12 07:35:38","updated_at":"2025-03-12 07:35:38"},{"id":13,"title":"ã‚","description":"ã‚","priority":{"value":1,"label":"ä½"},"due_date":null,"completed":false,"is_overdue":false,"created_at":"2025-03-12 07:35:14","updated_at":"2025-03-12 07:35:19"},{"id":3,"title":"Laravel ã®å‹‰å¼·","description":"API ã®ä½œæˆæ–¹æ³•ã‚’å­¦ã¶","priority":{"value":2,"label":"ä¸­"},"due_date":"2025-04-15","completed":false,"is_overdue":false,"created_at":"2025-03-12 03:01:52","updated_at":"2025-03-12 07:35:29"},{"id":2,"title":"Laravel ã®å‹‰å¼·","description":"API ã®ä½œæˆæ–¹æ³•ã‚’å­¦ã¶","priority":{"value":2,"label":"ä¸­"},"due_date":"2025-04-15","completed":false,"is_overdue":false,"created_at":"2025-03-12 02:51:13","updated_at":"2025-03-12 07:28:48"},{"id":1,"title":"Laravel ã®å‹‰å¼·","description":"API ã®ä½œæˆæ–¹æ³•ã‚’å­¦ã¶","priority":{<â€¦>

```

:::

### 3. ãƒ‡ãƒ¼ã‚¿å¤‰æ›å‡¦ç†

```dart
final List<dynamic> data = response.data['data'];
return data.map((json) => Todo.fromJson(json)).toList();
```

API ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ Dart ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã™ã‚‹å‡¦ç†ã€‚

### 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```dart
if (error.response?.statusCode == 422 && error.response?.data['errors'] != null) {
  final errorMessages = error.response?.data['errors'].entries
      .map((e) => '${e.key}: ${e.value.join(', ')}')
      .join('\n');
  return Exception('å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼:\n$errorMessages');
}
```

ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ï¼ˆ422ï¼‰ã‚’é©åˆ‡ã«å‡¦ç†ã€‚

### ä½™è«‡ï¼‰

ä»Šå›ã€ãƒ•ãƒ­ãƒ³ãƒˆå´ã§ 500 ã‚¨ãƒ©ãƒ¼ã®ã¿ãŒè¿”å´ã•ã‚Œã€è©³ç´°ãªã‚¨ãƒ©ãƒ¼å†…å®¹ãŒã‚ã‹ã‚‰ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã€‚ãã®éš›ã¯ Laravel ã®ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã®è©³ç´°å†…å®¹ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚Laravel å´ã®`storage/logs/laravel.log`ã€€ã‚’ç¢ºèªã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã‚’èªã‚ã¾ã—ãŸã€‚

```
[previous exception] [object] (PDOException(code: 23502): SQLSTATE[23502]: Not null violation: 7 ERROR:  null value in column \"completed\" of relation \"todos\" violates not-null constraint
DETAIL:  Failing row contains (12, ã‚, ã‚, 1, null, null, 2025-03-12 07:34:05, 2025-03-12 07:34:05).
```

ãƒ•ãƒ­ãƒ³ãƒˆå´ã§ Todo ä½œæˆæ™‚ã« completed ãŒ null ã§ã‚ã£ãŸãŸã‚ã€Todo ã« false ã®åˆæœŸå€¤ã‚’è¨­å®šã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£ãŒã§ãã¾ã—ãŸã€‚

## ã¾ã¨ã‚

Laravel ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ Flutter ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®é€£æºã«ã¯ã€ä»¥ä¸‹ã®ãƒã‚¤ãƒ³ãƒˆãŒé‡è¦ã§ã™ï¼š

1. Dio ãªã©ã®é«˜æ©Ÿèƒ½ HTTP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®æ´»ç”¨
2. Freezed ã‚’ä½¿ç”¨ã—ãŸãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…
3. ãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ†é›¢
4. é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å‘ä¸Š

ã“ã‚Œã‚‰ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€Laravel ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã‚¹ãƒ ãƒ¼ã‚ºã«é€£æºã™ã‚‹ Flutter ã‚¢ãƒ—ãƒªã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚
