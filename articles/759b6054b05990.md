---
title: "HealthKitã§ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã‚’ç®¡ç†ã™ã‚‹"
emoji: "ğŸ©º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [iOS,Swift,SwiftUI,HealthKit]
published: true
published_at: 2024-06-19 07:00 # æœªæ¥ã®æ—¥æ™‚ã‚’æŒ‡å®šã™ã‚‹
---

## ãƒ¡ãƒ³ã‚¿ãƒ«ã«é–¢ã—ã¦ã®æ–°ã—ã„HealthKitAPI

ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«HealthKitã«è¿½åŠ ã•ã‚ŒãŸæ–°ã—ã„APIãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚è‡ªåˆ†ã®æ°—åˆ†ã‚’æŒ¯ã‚Šè¿”ã‚Šã€å¿ƒã®çŠ¶æ…‹ã‚’è¨˜éŒ²ã—ã¦ç²¾ç¥çš„ãªå¥åº·çŠ¶æ…‹ã‚’è¿½è·¡ã§ãã¾ã™ã€‚ã¾ãŸã€AppleWatchã‹ã‚‰`State of Mind`ã‚’è¨˜éŒ²ã§ãã‚‹ãŸã‚ã€1æ—¥ã®ã©ã®æ™‚ç‚¹ã§ã‚‚ç°¡å˜ã«ãƒã‚§ãƒƒã‚¯ã§ãã¾ã™ã€‚

## è¿½åŠ ã•ã‚ŒãŸè©•ä¾¡ã‚·ãƒ¼ãƒˆ

![](/images/2024-06-15-21-08-21.png =500x)

ç²¾ç¥çŠ¶æ…‹ã‚’è©³ã—ãè©•ä¾¡ã™ã‚‹ãŸã‚ã«ã€Healthã‚¢ãƒ—ãƒªã§ä¸å®‰ã‚„ã†ã¤ç—…ã«é–¢ã™ã‚‹æ¨™æº–åŒ–ã•ã‚ŒãŸã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«å›ç­”ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚GAD-7ãŠã‚ˆã³PHQ-9ã¯è³ªå•ç¥¨ã§ã‚ã‚Šã€ä¸–ç•Œä¸­ã®åŒ»ç™‚å¾“äº‹è€…ãŒãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã«ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚GAD-7ï¼ˆä¸å®‰ç—‡ï¼‰ã¨PHQ-9ï¼ˆã†ã¤ç—…ï¼‰ã«é–¢ã™ã‚‹è©•ä¾¡ã®çµæœã‚’èª­ã¿æ›¸ããŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

## State of Mind API

![](/images/2024-06-15-21-08-37.png =400x)

State of Mindã¯ã€å€‹äººã®æ°—åˆ†ã‚„æ„Ÿæƒ…ã‚’è¡¨ç¾ã™ã‚‹æ–¹æ³•ã§ã™ã€‚æ„Ÿæƒ…ã¯çŸ­æœŸé–“ã®æ„Ÿæƒ…ã§ã™ãŒã€æ°—åˆ†ã¯é•·æœŸçš„ãªæ„Ÿæƒ…ã§ã™ã€‚è‡ªåˆ†ã®æ„Ÿæƒ…çŠ¶æ…‹ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã«ã¯ã€å¤šãã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

### State of Mindã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

State of Mindã«ã¯4ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚

- `Kind`(å¿ƒã®çŠ¶æ…‹)
- `Valence`(æ„Ÿæƒ…ã‚’ç¤ºã™å€¤)
- `Labels`(å¿ƒã®çŠ¶æ…‹ã‚’è¡¨ç¾ã™ã‚‹ãƒ©ãƒ™ãƒ«)
- `Associations`(å¿ƒã®çŠ¶æ…‹ã«é–¢é€£ã™ã‚‹äº‹æŸ„)

ã“ã‚Œã‚‰ã‚’ä½¿ç”¨ã—ã¦ã€èª°ã‹ã®ç²¾ç¥çŠ¶æ…‹ã‚’è¡¨ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å               | å‹                                    | èª¬æ˜                                           |
|----------------------------|---------------------------------------|------------------------------------------------|
| `kind`                     | `HKStateOfMind.Kind`                  | å¿ƒã®çŠ¶æ…‹ã®ç¨®é¡                                  |
| `valence`                  | `Double`                              | æ„Ÿæƒ…ã‚’ç¤ºã™å€¤                      |
| `labels`                   | `[HKStateOfMind.Label]`               | å¿ƒã®çŠ¶æ…‹ã‚’è¡¨ç¾ã™ã‚‹ãƒ©ãƒ™ãƒ«                |
| `associations`             | `[HKStateOfMind.Association]`         | å¿ƒã®çŠ¶æ…‹ã«é–¢é€£ã™ã‚‹äº‹æŸ„                 |

#### Kind:å¿ƒã®çŠ¶æ…‹ã®ç¨®é¡

| ã‚±ãƒ¼ã‚¹å                | èª¬æ˜                               |
|-------------------------|------------------------------------|
| `dailyMood`             | æ—¥ã€…ã®æ°—åˆ†ã‚’ç¤ºã™                   |
| `momentaryEmotion`      | ä¸€æ™‚çš„ãªæ„Ÿæƒ…ã‚’ç¤ºã™                 |

![](/images/2024-06-15-21-09-14.png =500x)

#### Valence:æ„Ÿæƒ…ã‚’ç¤ºã™å€¤

![](/images/2024-06-15-21-09-24.png =500x)

#### Labels:æ„Ÿæƒ…ã‚’è¡¨ç¾ã™ã‚‹

| ã‚±ãƒ¼ã‚¹å                | èª¬æ˜                               |
|-------------------------|------------------------------------|
| `amazed`                | é©šã„ãŸ                             |
| `amused`                | é¢ç™½ãŒã£ãŸ                         |
| `angry`                 | æ€’ã£ãŸ                             |
| `annoyed`               | ã‚¤ãƒ©ã‚¤ãƒ©ã—ãŸ                       |
| `anxious`               | ä¸å®‰                               |
| `ashamed`               | æ¥ã˜ã‚‹                             |
| `brave`                 | å‹‡æ•¢                               |
| `calm`                  | è½ã¡ç€ã„ãŸ                         |
| `confident`             | è‡ªä¿¡ãŒã‚ã‚‹                         |
| `content`               | æº€è¶³                               |
| `disappointed`          | å¤±æœ›ã—ãŸ                           |
| `discouraged`           | è½èƒ†ã—ãŸ                           |
| `disgusted`             | å«Œæ‚ªã—ãŸ                           |
| `drained`               | ç–²ã‚Œæœã¦ãŸ                         |
| `embarrassed`           | æ¥ãšã‹ã—ã„                         |
| `excited`               | èˆˆå¥®ã—ãŸ                           |
| `frustrated`            | ä¸æº€ã‚’æ„Ÿã˜ãŸ         |
| `grateful`              | æ„Ÿè¬ã—ã¦ã„ã‚‹                       |
| `guilty`                | ç½ªæ‚ªæ„Ÿã‚’æ„Ÿã˜ãŸ                     |
| `happy`                 | å¹¸ã›                               |
| `hopeful`               | å¸Œæœ›ã«æº€ã¡ãŸ                       |
| `hopeless`              | çµ¶æœ›çš„                             |
| `indifferent`           | ç„¡é–¢å¿ƒ                             |
| `irritated`             | ã‚¤ãƒ©ã‚¤ãƒ©ã—ãŸ                       |
| `jealous`               | å«‰å¦¬ã—ãŸ                           |
| `joyful`                | å–œã³                               |
| `lonely`                | å­¤ç‹¬                               |
| `overwhelmed`           | åœ§å€’ã•ã‚ŒãŸ                         |
| `passionate`            | æƒ…ç†±çš„                             |
| `peaceful`              | å¹³å’Œ                               |
| `proud`                 | èª‡ã‚Šã«æ€ã†                         |
| `relieved`              | å®‰å µã—ãŸ                           |
| `sad`                   | æ‚²ã—ã„                             |
| `satisfied`             | æº€è¶³ã—ãŸ                           |
| `scared`                | æ€–ã„                               |
| `stressed`              | ã‚¹ãƒˆãƒ¬ã‚¹ã‚’æ„Ÿã˜ãŸ                   |
| `surprised`             | é©šã„ãŸ                             |
| `worried`               | å¿ƒé…ã—ãŸ                           |

![](/images/2024-06-15-21-09-39.png =500x)

#### Associations:å¿ƒã®çŠ¶æ…‹ã«é–¢é€£ã™ã‚‹äº‹æŸ„

| ã‚±ãƒ¼ã‚¹å                | èª¬æ˜                               |
|-------------------------|------------------------------------|
| `community`             | ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£                       |
| `currentEvents`         | ç¾åœ¨ã®å‡ºæ¥äº‹                       |
| `dating`                | ãƒ‡ãƒ¼ãƒˆ                             |
| `education`             | æ•™è‚²                               |
| `family`                | å®¶æ—                               |
| `fitness`               | ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹                       |
| `friends`               | å‹äºº                               |
| `health`                | å¥åº·                               |
| `hobbies`               | è¶£å‘³                               |
| `identity`              | ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£                   |
| `money`                 | ãŠé‡‘                               |
| `partner`               | ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼                         |
| `selfCare`              | ã‚»ãƒ«ãƒ•ã‚±ã‚¢                         |
| `spirituality`          | ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒªãƒ†ã‚£                 |
| `tasks`                 | ã‚¿ã‚¹ã‚¯                             |
| `travel`                | æ—…è¡Œ                               |
| `weather`               | å¤©æ°—                               |
| `work`                  | ä»•äº‹                               |

![](/images/2024-06-15-21-09-56.png =500x)

### `HKStateOfMind`ã‚µãƒ³ãƒ—ãƒ«ã®ä¿å­˜æ–¹æ³•ï¼ˆå®Ÿè£…ä¾‹ï¼‰

æ–°ã—ã„APIã‚’ä½¿ç”¨ã—ã¦ã€çµµæ–‡å­—ã‚’ä½¿ç”¨ã—ã¦æ°—åˆ†ã‚’è¨˜éŒ²ã—ã€ãã‚Œã‚’HealthKitã«ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãšã¯è¨˜éŒ²ã—ãŸã„æ„Ÿæƒ…ã‚’å®šç¾©ã—ã¾ã™ã€‚å‘¼ã³å‡ºã—ã‚„ã™ã„ã‚ˆã†ã«çµµæ–‡å­—ã‚’ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§å®šç¾©ã—ã¾ã™ã€‚

```swift
enum EmojiType: CaseIterable {
    case angry
    case sad
    case indifferent
    case satisfied
    case happy
    
    var emoji: String {
        switch self {
        case .angry: return "ğŸ˜¡"
        case .sad: return "ğŸ˜¢"
        case .indifferent: return "ğŸ˜"
        case .satisfied: return "ğŸ˜Œ"
        case .happy: return "ğŸ˜Š"
        }
    }
}
```

ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œæˆã—ã¾ã™ã€‚æ„Ÿæƒ…ã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ã«ã¯ã€`HKStateOfMind`ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```swift
/// ã‚¤ãƒ™ãƒ³ãƒˆã¨çµµæ–‡å­—ã®é¸æŠã«åŸºã¥ã„ãŸState of Mindã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œæˆ
func createSample(for event: EventModel, emojiType: EmojiType) ->
HKStateOfMind {
    let kind: HKStateOfMind.Kind = .momentaryEmotion
    let valence: Double = emojiType.valence
    let label = emojiType.label
    let association = event.association
    return HKStateOfMind(date: event.endDate,
                         kind: kind,
                         valence: valence,
                         labels: [label],
                         associations: [association])
}
```

`HKStateOfMind`ã‚µãƒ³ãƒ—ãƒ«ã‚’HealthKitStoreã«ä¿å­˜ã—ã¾ã™ã€‚

```swift
// çµµæ–‡å­—ã®é¸æŠã‹ã‚‰State of Mindã‚µãƒ³ãƒ—ãƒ«ã‚’ä¿å­˜
func save(sample: HKSample, healthStore: HKHealthStore) async {
    do {
        try await healthStore.save(sample)
    } catch {
        // ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’ã“ã“ã«è¨˜è¿°
    }
}

```

### æ–°ã—ã„æ¡ä»¶æ¤œç´¢

HealthKitã§ã‚µãƒ³ãƒ—ãƒ«ã‚’æ¤œç´¢ã™ã‚‹ãŸã‚ã®4ã¤ã®æ–°ã—ã„æ¡ä»¶æŒ‡å®šï¼ˆPredicateï¼‰ã‚’å°å…¥ã—ã¾ã™ã€‚`Kind`ãƒ»`Valence`ãƒ»`Labels`ãƒ»`Associations`ã‚’æŒ‡å®šã—ã¦ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å¿…è¦ãªæƒ…å ±ã‚’ç°¡å˜ã«å–å¾—ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

#### Predicateã®ãƒ¡ã‚½ãƒƒãƒ‰ç´¹ä»‹

##### `Kind`

![](/images/2024-06-15-21-11-40.png)

##### `Valence`

![](/images/2024-06-15-21-11-50.png)

##### `Labels`

![](/images/2024-06-15-21-12-14.png)

##### `Associations`

![](/images/2024-06-15-21-12-25.png)

### `HKStateOfMind`ã‚µãƒ³ãƒ—ãƒ«ã®å‘¼ã³å‡ºã—ï¼ˆå®Ÿè£…ä¾‹ï¼‰

`StateofMind`ã‚µãƒ³ãƒ—ãƒ«ã‚’å‘¼ã³å‡ºã™å®Ÿè£…ä¾‹ã§ã™ã€‚

```swift
// æ—¥ä»˜ã®æ¡ä»¶æŒ‡å®šã‚’è¡Œã†ãŸã‚ã®NSPredicateã‚’å®šç¾©
let datePredicate: NSPredicate = { ... }

// associationsã®å„è¦ç´ ã«å¯¾ã—ã¦ã€å¯¾å¿œã™ã‚‹HKQueryã®çŠ¶æ…‹ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®predicateã‚’ä½œæˆ
let associationsPredicate = NSCompoundPredicate(
    orPredicateWithSubpredicates: associations.map {
        // HKQueryã®çŠ¶æ…‹ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®predicateã‚’ä½œæˆ
        HKQuery.predicateForStatesOfMind(with: $0)
    }
)

// è¤‡åˆæ¡ä»¶ã®predicateã‚’ä½œæˆ
let compoundPredicate = NSCompoundPredicate(
    andPredicateWithSubpredicates: [datePredicate, associationsPredicate]
)

// æ¡ä»¶æŒ‡å®šã‚’è¡Œã†ãŸã‚ã®predicateã‚’ä½œæˆ
let stateOfMindPredicate = HKSamplePredicate.stateOfMind(compoundPredicate)

// ã‚µãƒ³ãƒ—ãƒ«ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®descriptorã‚’å®šç¾©
let descriptor = HKSampleQueryDescriptor(predicates: [stateOfMindPredicate],
                                         sortDescriptors: [])

// ã‚¯ã‚¨ãƒªã®çµæœã‚’æ ¼ç´ã™ã‚‹é…åˆ—ã‚’å®šç¾©
var results: [HKStateOfMind] = []

do {
    // ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦çµæœã‚’éåŒæœŸã§å¾…ã¤
    results = try await descriptor.result(for: healthStore)
} catch {
    // ã‚¯ã‚¨ãƒªå®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®å‡¦ç†ã‚’ã“ã“ã«è¨˜è¿°
    print("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: \(error)")
}

```

ç‰¹å®šã®ãƒ©ãƒ™ãƒ«ã‚’æŒã¤`StateofMind`ã‚µãƒ³ãƒ—ãƒ«ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®å®Ÿè£…ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚

```swift
// æŒ‡å®šã™ã‚‹ãƒ©ãƒ™ãƒ«ã‚’å®šç¾©
let label: HKStateOfMind.Label = .happy

// ãƒ©ãƒ™ãƒ«æ¡ä»¶ã®predicateã‚’ä½œæˆ
let labelPredicate = HKQuery.predicateForStatesOfMind(with: label)
```

## `Valence`ï¼ˆæ„Ÿæƒ…ã‚’ç¤ºã™å€¤ï¼‰ã®è¡¨ç¾æ–¹æ³•

`Valence`ã®å€¤ã¯`-1`ã€œ`1`ã§ã‚ã‚‹ãŸã‚ã€ã©ã®ã‚ˆã†ã«è¡¨ç¾ã™ã‚‹ã‹ã¯ã‚¢ãƒ—ãƒªã«ã‚ˆã£ã¦å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```swift
// å„valenceå€¤ã‚’0.0ã‹ã‚‰2.0ã®ç¯„å›²ã«èª¿æ•´
let adjustedValenceResults = results.map { $0.valence + 1.0 }
// å¹³å‡å€¤ã‚’è¨ˆç®—
let totalAdjustedValence = adjustedValenceResults.reduce(0.0, +)
let averageAdjustedValence = totalAdjustedValence / Double(results.count)
// ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã«å¤‰æ›
let adjustedValenceAsPercent = Int(100.0 * (averageAdjustedValence / 2.0))
```

## ã¾ã¨ã‚

æ–°ã—ã„HealthKitAPIã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã®ç®¡ç†ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚å€‹äººã®æ°—åˆ†ã‚„æ„Ÿæƒ…ã‚’è¨˜éŒ²ã—ã€è©³ç´°ãªè©•ä¾¡ã‚’è¡Œã†ã“ã¨ã§ã€ç²¾ç¥çŠ¶æ…‹ã‚’æŒ¯ã‚Šè¿”ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»Šå¾Œã€ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã®ç®¡ç†ã‚’iOSã§è¡Œã†å ´åˆã¯å°å…¥ã—ã¦ã„ãã¹ãã ã¨æ„Ÿã˜ã¾ã—ãŸã€‚

## å‚è€ƒè³‡æ–™

https://developer.apple.com/documentation/healthkit/hkstateofmind

https://developer.apple.com/videos/play/wwdc2024/10109/
