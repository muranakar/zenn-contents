---
title: "ã€Flutterã€‘BLoCãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã—ãŸTodoã‚¢ãƒ—ãƒªã®å®Ÿè£… with sqflite"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Flutter, Dart, SQlite]
published: true
published_at: 2025-02-18 07:00 # æœªæ¥ã®æ—¥æ™‚ã‚’æŒ‡å®šã™ã‚‹
---

BLoC ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã®å®Ÿè£…æ–¹æ³•ã‚’å­¦ã³ãŸã„ã¨æ€ã„ã€ãƒ¡ãƒ¢ã¨ã—ã¦è¨˜ã—ã¦ãŠãã¾ã™ã€‚ã“ã® Todo ã‚¢ãƒ—ãƒªã§ã¯ã€BLoC ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã‚’ç®¡ç†ã—ã€SQLite ã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚ä»Šå›ã¯ç°¡å˜ãª CRUD æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã®ã¿ã¨ã—ã¾ã™ã€‚ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«å®Ÿè£…ã—ã¦ãŠã‚Šã¾ã™ã€‚

https://vaygeth.medium.com/reactive-flutter-todo-app-using-bloc-design-pattern-b71e2434f692

#### ä»Šå›ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

https://github.com/muranakar/sqflite_bloc

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹æˆ

ã¾ãšå¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’`pubspec.yaml`ã«è¿½åŠ ã—ã¾ã™:

```yaml
dependencies:
  sqflite: ^2.3.0 # SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç”¨
  path_provider: ^2.1.1 # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹å–å¾—ç”¨
```

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
lib/
  â”œâ”€â”€ bloc/
  â”‚   â””â”€â”€ todo_bloc.dart
  â”œâ”€â”€ dao/
  â”‚   â””â”€â”€ todo_dao.dart
  â”œâ”€â”€ database/
  â”‚   â””â”€â”€ database.dart
  â”œâ”€â”€ model/
  â”‚   â””â”€â”€ todo.dart
  â”œâ”€â”€ repository/
  â”‚   â””â”€â”€ todo_repository.dart
  â””â”€â”€ ui/
      â””â”€â”€ home_page.dart
```

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…

ã¾ãš`Todo`ãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™:

```dart

class Todo {
  int id;
  String description;
  bool isDone;

  // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ - isDoneã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§false
  Todo({
    this.id,
    this.description,
    this.isDone = false
  });

  // JSONã‹ã‚‰Todoã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã™ã‚‹ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰
  factory Todo.fromDatabaseJson(Map<String, dynamic> data) => Todo(
    id: data['id'],
    description: data['description'],
    // SQLiteã«ã¯booleanå‹ãŒãªã„ãŸã‚ã€0/1ã§ç®¡ç†
    isDone: data['is_done'] == 0 ? false : true,
  );

  // Todoã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’JSONã«å¤‰æ›ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
  Map<String, dynamic> toDatabaseJson() => {
    "id": this.id,
    "description": this.description,
    "is_done": this.isDone == false ? 0 : 1,
  };
}
```

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å®Ÿè£…

SQLite ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é–¢é€£ã™ã‚‹è©³ç´°è¨­å®šãªã©ã‚’è¡Œã„ã¾ã™ã€‚

```dart
class DatabaseProvider {
  static final DatabaseProvider dbProvider = DatabaseProvider();
  Database _database;

  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—
  Future<Database> get database async {
    if (_database != null) return _database;
    _database = await createDatabase();
    return _database;
  }

  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆ
  createDatabase() async {
    // ã‚¢ãƒ—ãƒªã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
    Directory documentsDirectory = await getApplicationDocumentsDirectory();
    String path = join(documentsDirectory.path, "TodoApp.db");

    var database = await openDatabase(
      path,
      version: 1,
      onCreate: initDB,
      onUpgrade: onUpgrade
    );
    return database;
  }

  // ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
  void initDB(Database database, int version) async {
    await database.execute("""
      CREATE TABLE Todo (
        id INTEGER PRIMARY KEY,
        description TEXT,
        is_done INTEGER
      )
    """);
  }

  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ›´æ–°æ™‚ã®å‡¦ç†
  void onUpgrade(Database database, int oldVersion, int newVersion) {
    if (newVersion > oldVersion) {
      // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ã‚’è¨˜è¿°
    }
  }
}
```

## ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å®Ÿè£…

Todo ã® CRUD æ“ä½œã‚’è¡Œã† DAO ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ã“ã® DAO ã‚¯ãƒ©ã‚¹å†…ã§ sqflite ã® CRUD å‡¦ç†ã‚’é–‰ã˜è¾¼ã‚ã‚‹ã“ã¨ã§ã€sqflite ã®å®Ÿè£…ã‚’å¤‰æ›´ã™ã‚‹ç¯„å›²ã‚’å°ã•ãã—ã¾ã™ã€‚

```dart
class TodoDao {
  final dbProvider = DatabaseProvider.dbProvider;

  // Todoä½œæˆ
  Future<int> createTodo(Todo todo) async {
    final db = await dbProvider.database;
    var result = db.insert('Todo', todo.toDatabaseJson());
    return result;
  }

  // Todoä¸€è¦§å–å¾—
  Future<List<Todo>> getTodos({String? query}) async {
    final db = await dbProvider.database;

    List<Map<String, dynamic>> result;
    if (query != null && query.isNotEmpty) {
      result = await db
          .query('Todo', where: 'description LIKE ?', whereArgs: ["%$query%"]);
    } else {
      result = await db.query('Todo');
    }

    List<Todo> todos = result.isNotEmpty
        ? result.map((item) => Todo.fromDatabaseJson(item)).toList()
        : [];
    return todos;
  }

  // æ›´æ–°ã¨å‰Šé™¤ã¯çœç•¥
}
```

## ãƒªãƒã‚¸ãƒˆãƒªãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å®Ÿè£…

TodoRepository ã¯ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®æŠ½è±¡åŒ–ã‚’è¡Œã„ã¾ã™:

```dart
class TodoRepository {
  final todoDao = TodoDao();

  Future getAllTodos({String? query}) => todoDao.getTodos(query: query);

  Future insertTodo(Todo todo) => todoDao.createTodo(todo);

  // æ›´æ–°ã¨å‰Šé™¤ã¯çœç•¥
}
```

## BLoC ã®å®Ÿè£…

TodoBLoC ã¯ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¨ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œã‚’ç®¡ç†ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€TODO ãƒªã‚¹ãƒˆã®æ–°è¦è¿½åŠ ã‚’è¡Œã£ãŸã‚ã¨ã«ã€ã™ã¹ã¦ã® TODO ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã‚€å‡¦ç†ã®æµã‚Œã‚’å®Ÿè£…ã™ã‚‹ã€‚

```dart
class TodoBloc {
  final _todoRepository = TodoRepository();

  // StreamControllerã§Todoãƒªã‚¹ãƒˆã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ç®¡ç†
  final _todoController = StreamController<List<Todo>>.broadcast();

  // Todoãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ 
  Stream<List<Todo>> get todos => _todoController.stream;

  TodoBloc() {
    getTodos();
  }

  // Todoãƒªã‚¹ãƒˆã®å–å¾—
  getTodos({String query}) async {
    _todoController.sink.add(
      await _todoRepository.getAllTodos(query: query)
    );
  }

  // æ–°è¦Todoè¿½åŠ 
  addTodo(Todo todo) async {
    await _todoRepository.insertTodo(todo);
    getTodos();
  }

  // æ›´æ–°ã¨å‰Šé™¤ã¯çœç•¥
}
```

## UI ã®å®Ÿè£…

æœ€å¾Œã« UI ã‚’å®Ÿè£…ã—ã¾ã™ã€‚`StreamBuilder` ã‚’ä½¿ç”¨ã—ã¦ `Todo` ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã—ã¾ã™:

- `TodoBloc` ã‚’å®£è¨€ã—ã¦ã€`todos` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç”¨ã„ã¦å€¤ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
- è¿½åŠ ãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã¯ã€ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨ã„ã¦å‡¦ç†ã—ã¾ã™ã€‚
- `TextEditingController` ã‚’ç”¨ã„ã¦ã€ã‚¯ã‚¨ãƒªã‚’ç”¨ã„ã¦è©²å½“ã™ã‚‹ `todo` ã‚’æ¤œç´¢ã§ãã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰é‡ãŒå¤šããªã‚‹ãŸã‚ã€è©³ç´°ã¯ Github ã‚’ã”è¦§ãã ã•ã„ã€‚

https://github.com/muranakar/sqflite_bloc/blob/main/lib/ui/home_page.dart#L5-L143

## ã¾ã¨ã‚

BLoC ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆãŒå¾—ã‚‰ã‚Œã¾ã™:

- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¨ UI ã®åˆ†é›¢
- ã‚³ãƒ¼ãƒ‰ã®å†åˆ©ç”¨æ€§ã®å‘ä¸Š
- ãƒ†ã‚¹ãƒˆã®å®¹æ˜“ã•
- çŠ¶æ…‹ç®¡ç†ã®ä¸€å…ƒåŒ–

ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€Stream ã¨ StreamController ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œã‚’ç®¡ç†ã—ã€SQLite ã§ãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šåŒ–ã—ã¦ã„ã¾ã™ã€‚å„ãƒ¬ã‚¤ãƒ¤ãƒ¼(Modelã€DAOã€Repositoryã€BLoC)ãŒæ˜ç¢ºãªè²¬å‹™ã‚’æŒã¡ã€ä¿å®ˆæ€§ã®é«˜ã„ã‚³ãƒ¼ãƒ‰ã¨ãªã£ã¦ã„ã¾ã™ã€‚

## å‚ç…§

https://vaygeth.medium.com/reactive-flutter-todo-app-using-bloc-design-pattern-b71e2434f692
