---
title: "＝＝＝＝＝＝＝【Flutter】日記アプリのDBデータのエクスポート方法"
emoji: "👋"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Flutter, Dart]
published: false
---

シンプルな TODO リストのデータベース実装と各形式でのエクスポート方法を説明します。

```dart
import 'dart:io';
import 'package:path/path.dart';
import 'package:sqflite/sqflite.dart';
import 'package:path_provider/path_provider.dart';

class TodoDatabase {
  static final TodoDatabase instance = TodoDatabase._init();
  static Database? _database;

  TodoDatabase._init();

  // データベースの作成
  Future<void> _createDB(Database db, int version) async {
    await db.execute('''
    CREATE TABLE todos (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      title TEXT,
      is_completed INTEGER,
      created_at TEXT
    )
    ''');
  }

  // テキストファイル形式でエクスポート
  Future<String> exportToTxt() async {
    final db = await _database;
    final todos = await db!.query('todos');

    final docDir = await getApplicationDocumentsDirectory();
    final txtFile = File(join(docDir.path, 'todos.txt'));

    final buffer = StringBuffer();
    buffer.writeln('===== TODOリスト =====');

    for (var todo in todos) {
      buffer.writeln('ID: ${todo['id']}');
      buffer.writeln('タスク: ${todo['title']}');
      buffer.writeln('状態: ${todo['is_completed'] == 1 ? '完了' : '未完了'}');
      buffer.writeln('作成日時: ${todo['created_at']}');
      buffer.writeln('-------------------');
    }

    await txtFile.writeAsString(buffer.toString());
    return txtFile.path;
  }

  // CSVファイル形式でエクスポート
  Future<String> exportToCsv() async {
    final db = await _database;
    final todos = await db!.query('todos');

    final docDir = await getApplicationDocumentsDirectory();
    final csvFile = File(join(docDir.path, 'todos.csv'));

    final buffer = StringBuffer();
    buffer.writeln('id,title,is_completed,created_at');

    for (var todo in todos) {
      final values = [
        todo['id'],
        '"${todo['title']}"',
        todo['is_completed'],
        todo['created_at']
      ];
      buffer.writeln(values.join(','));
    }

    await csvFile.writeAsString(buffer.toString());
    return csvFile.path;
  }

  // データベースファイルのバックアップ
  Future<String> exportDatabase() async {
    try {
      if (_database != null && _database!.isOpen) {
        await _database!.close();
        _database = null;
      }

      final dbPath = await getDatabasesPath();
      final dbFile = File(join(dbPath, 'todo.db'));

      final docDir = await getApplicationDocumentsDirectory();
      final backupPath = join(docDir.path, 'todo_backup.db');

      await dbFile.copy(backupPath);
      return backupPath;
    } catch (e) {
      print('バックアップエラー: $e');
      rethrow;
    }
  }

  // データの追加例
  Future<void> insertTodo(String title) async {
    final db = await _database;
    await db!.insert('todos', {
      'title': title,
      'is_completed': 0,
      'created_at': DateTime.now().toIso8601String()
    });
  }
}

// 使用例
void example() async {
  // サンプルデータの追加
  await TodoDatabase.instance.insertTodo('買い物に行く');
  await TodoDatabase.instance.insertTodo('本を読む');

  // 各形式でエクスポート
  final txtPath = await TodoDatabase.instance.exportToTxt();
  print('テキストファイルを作成: $txtPath');

  final csvPath = await TodoDatabase.instance.exportToCsv();
  print('CSVファイルを作成: $csvPath');

  final dbPath = await TodoDatabase.instance.exportDatabase();
  print('データベースをバックアップ: $dbPath');
}
```

# 各形式での出力例

## 1. テキストファイル (todos.txt)

```text
===== TODOリスト =====
ID: 1
タスク: 買い物に行く
状態: 未完了
作成日時: 2024-01-21T10:00:00
-------------------
ID: 2
タスク: 本を読む
状態: 未完了
作成日時: 2024-01-21T10:05:00
-------------------
```

## 2. CSV ファイル (todos.csv)

```csv
id,title,is_completed,created_at
1,"買い物に行く",0,2024-01-21T10:00:00
2,"本を読む",0,2024-01-21T10:05:00
```

## 3. データベースファイル (todo.db)

- SQLite データベースファイル
- テーブル構造：

```sql
CREATE TABLE todos (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT,
  is_completed INTEGER,
  created_at TEXT
)
```

## 主な機能

1. データベースの作成

```dart
await db.execute('''
CREATE TABLE todos (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT,
  is_completed INTEGER,
  created_at TEXT
)
''');
```

2. データの追加

```dart
await database.insert('todos', {
  'title': title,
  'is_completed': 0,
  'created_at': DateTime.now().toIso8601String()
});
```

3. バックアップの作成

```dart
final dbFile = File(join(dbPath, 'todo.db'));
final backupPath = join(docDir.path, 'todo_backup.db');
await dbFile.copy(backupPath);
```

## 使用方法

```dart
final db = TodoDatabase.instance;

// テキストファイルとしてエクスポート
final txtPath = await db.exportToTxt();

// CSVファイルとしてエクスポート
final csvPath = await db.exportToCsv();

// データベースファイルとしてバックアップ
final dbPath = await db.exportDatabase();
```

この実装により、シンプルな TODO リストのデータを各形式で簡単にエクスポートできます。データ構造がシンプルなため、形式間の変換も容易です。
