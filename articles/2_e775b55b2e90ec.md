---
title: "【iOS】HealthKitでの１ヶ月間の歩数を取得する"
emoji: "🩺"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [iOS,Swift,SwiftUI,HealthKit]
published: false # trueを指定する

---


# 【iOS】HealthKitでの１ヶ月間の歩数を取得する

```markdown
## 概要

`StatisticsCollectionQueries`を使用して、グラフやチャートのデータを生成します。たとえば、毎日の合計歩数や時間ごとの平均心拍数を計算する`StatisticsCollectionQueries`を作成できます。

## 注記

HealthKitは、サンプルセットの統計を計算するための2種類のクエリを提供します。`HKStatisticsQuery`は一致するすべてのサンプルに対して単一の値を計算し、`HKStatisticsCollectionQuery`はサンプルをインターバルに分割して、各インターバルの値を計算(合計・平均・最大・最小etc)します。

`StatisticsCollectionQueries`は、アンカーとインターバルを使用して、一致するサンプル毎に分割します。アンカーは任意の開始点を定義し、その位置は重要ではありません。インターバルはこのアンカーから両方向に広がります。

## 指定されたアンカーの周囲の各インターバルの値を示す図

![Anchorに関する図](/images/2024-05-24-06-43-11.png)

たとえば、1日のインターバルを使用する場合、アンカーは各データ収集が開始される時刻を定義します。アンカーの正確な日時は重要ではありません。1970年1月1日の午前3時34分でも、2065年3月15日の午前3時34分でも構いません。どちらの場合でも、`StatisticsCollectionQueries`は毎日午前3時34分から開始し、一致するサンプルを数日に分割します。

次に、`StatisticsCollectionQueries`は一定の間隔にわたって共通の計算します。`StatisticsCollectionQueries`を使用すると、一定間隔のサンプル集の最小値、最大値、平均値を計算したり、累積数量の合計を計算したりできます。また、オブザーバークエリと同様に、`StatisticsCollectionQueries`はバックグラウンドキューで実行するクエリとして機能し、HealthKitストアのデータが変更されたときに更新を受け取ることができます。

## クエリを作成する

まず、アンカーの日付とデータ取得期間の条件を作成します。次の例では、​​過去1ヶ月分の歩数データを1週間の間隔に分けてデータ取得します。次に、アンカーの日付を実行時点の1日後に設定します。

```swift
// 今月のサンプルの検索条件を実装する
let calendar = Calendar(identifier: .gregorian)
let today = calendar.startOfDay(for: Date())


guard let endDate = calendar.date(byAdding: .day, value: 1, to: today) else {
    fatalError("*** 終了時間を計算できませんでした ***")
}


guard let startDate = calendar.date(byAdding: .month, value: -1, to: endDate) else {
    fatalError("*** 開始時間を計算できませんでした ***")
}

let thisMonth = HKQuery.predicateForSamples(withStart: startDate, end: endDate)

let everyWeek = DateComponents(day:7)
```

次に、`QuantityType`と`StatisticsCollectionQueries`を作成します。次のコードは、歩数の`QuantityType`を作成し、クエリ自体を作成します。

```swift
let stepType = HKQuantityType(.stepCount)
let stepsThisMonth = HKSamplePredicate.quantitySample(type: stepType, predicate:thisMonth)


// クエリを作成
let sumOfStepsQuery = HKStatisticsCollectionQueryDescriptor(
    predicate: stepsThisMonth,
    options: .cumulativeSum,
    anchorDate: endDate,
    intervalComponents: everyWeek)


let stepCounts = try await sumOfStepsQuery.result(for: store)
```

## クエリを実行する

最後に、HealthKitストアを使用してクエリを実行します。

```swift
healthStore.execute(query)
```