---
title: "ã€iOSã€‘Workout Sessionå…¥é–€"
emoji: "ğŸ©º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [iOS,Swift,SwiftUI,HealthKit,watchOS]
published: true # trueã‚’æŒ‡å®šã™ã‚‹
published_at: 2024-06-10 07:00 # æœªæ¥ã®æ—¥æ™‚ã‚’æŒ‡å®šã™ã‚‹

---

![](/images/2024-06-09-05-48-54.png)

## Workoutãƒ»WorkoutSessionã¨ã¯ï¼Ÿ

AppleWatchã®ï¼‘ã¤ã®æ©Ÿèƒ½ã§ã‚ã‚‹ã€ŒWorkoutã€ã§ã™ã€‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒæ—¥å¸¸ç”Ÿæ´»ã®æ´»å‹•é‡ã‚’å¸¸æ™‚è¨ˆæ¸¬ã™ã‚‹ã®ã«å¯¾ã—ã¦ã€Workoutã¯ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚„ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ã€ã‚¸ãƒ ã§ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãªã©ã€é‹å‹•ã‚’è¨ˆæ¸¬ã—ã¾ã™ã€‚AppleWatchã§Workoutã‚’è¿½è·¡ã™ã‚‹ã«ã¯ã€WorkoutSessionã‚’è¨­å®šã€é–‹å§‹ã€ä¿å­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€WorkoutSessionã«é–¢ã—ã¦æ·±å €ã‚Šã—ã¾ã™ã€‚




https://developer.apple.com/documentation/healthkit/workouts_and_activity_rings/build_a_workout_app_for_apple_watch

https://developer.apple.com/documentation/healthkit/workouts_and_activity_rings/running_workout_sessions

ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å‚è€ƒã«é€²ã‚ã¾ã™ã€‚ä¸»ã«Workoutã®çŠ¶æ…‹ã‚’ç®¡ç†ã—ã¦ã„ã‚‹`WorkoutManager`ã«ç€ç›®ã—ã¦è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ–¹æ³•ã«é–¢ã—ã¦ä»¥ä¸‹ã«ã¾ã¨ã‚ã¦ã„ã¾ã™ã®ã§å‚è€ƒã¾ã§ã«ã”è¦§ãã ã•ã„ã€‚

https://zenn.dev/muranaka/articles/8d58f0065f19a7

## æ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

WorkoutSessionã‚’ä½œæˆã™ã‚‹å‰ã«ã€HealthKitã‚’è¨­å®šã—ã€ã‚¢ãƒ—ãƒªãŒä½¿ç”¨ã™ã‚‹ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Šã¨å…±æœ‰ã®è¨±å¯ã‚’è¦æ±‚ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```swift 
    // Request authorization to access HealthKit.
    func requestAuthorization() {
        // The quantity type to write to the health store.
        let typesToShare: Set = [
            HKQuantityType.workoutType()
        ]

        // The quantity types to read from the health store.
        let typesToRead: Set = [
            HKQuantityType.quantityType(forIdentifier: .heartRate)!,
            HKQuantityType.quantityType(forIdentifier: .activeEnergyBurned)!,
            HKQuantityType.quantityType(forIdentifier: .distanceWalkingRunning)!,
            HKQuantityType.quantityType(forIdentifier: .distanceCycling)!,
            HKObjectType.activitySummaryType()
        ]

        // Request authorization for those quantity types.
        healthStore.requestAuthorization(toShare: typesToShare, read: typesToRead) { (success, error) in
            // Handle error.
        }
    }
```
`requestAuthorization`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨ã„ã¦ã€ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†ä¸Šã§ã®æ¨©é™ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

- `toShare`ã€€ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿ãŸã‚
- `read`ã€€ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿

ã«ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—(workoutã€å¿ƒæ‹æ•°ã€æ­©è¡Œè·é›¢etc)ã‚’æŒ‡å®šã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚

## Background Modesã®è¨­å®š

WorkoutSessionã‚’ç”¨ã„ã‚‹ã‚¢ãƒ—ãƒªã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œå¯èƒ½ã§ã‚ã‚‹ãŸã‚ã€WatchKit App Extensionã«ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

![](/images/2024-06-07-06-47-39.png)

## Workoutã‚’é–‹å§‹ã™ã‚‹

### HKWorkoutConfigurationã®è¨­å®š

[`HKWorkoutConfiguration()`](https://developer.apple.com/documentation/healthkit/hkworkoutconfiguration)ã‚’ç”Ÿæˆã—ã¦ã€é‹å‹•ã®ç¨®é¡ã€å±‹å†…orå±‹å¤–ã‚’è¨­å®šã™ã‚‹ã€‚

```swift
let configuration = HKWorkoutConfiguration()
configuration.activityType = workoutType
configuration.locationType = .outdoor
```

:::message
HealthKitã¯ã€ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã€ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ã€ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°ã€éšæ®µç™»ã‚Šã®æ´»å‹•ã«å¯¾ã—ã¦æœ€é©åŒ–ã•ã‚ŒãŸã‚«ãƒ­ãƒªãƒ¼è¨ˆç®—ã‚’æä¾›ã—ã¾ã™ã€‚ã•ã‚‰ã«ã€ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã€ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ã€ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°ã®æ´»å‹•ã«é–¢ã—ã¦ã¯ã€å±‹å†…ã¨å±‹å¤–ã®å ´æ‰€ã«ã‚ˆã£ã¦è¨ˆç®—ãŒç•°ãªã‚Šã¾ã™ã€‚
:::

### HKLiveWorkoutBuilderã®ç”Ÿæˆ

`HKWorkoutConfiguration()` ã‚’ä½¿ç”¨ã—ã¦`HKWorkoutSession`ã‚’ä½œæˆã—ã¾ã™ã€‚ãã®å¾Œã€`HKWorkoutSession`ã‹ã‚‰`HKLiveWorkoutBuilder`ã‚’å–å¾—ã—ã¾ã™ã€‚

```swift
do {
    session = try HKWorkoutSession(healthStore: healthStore, configuration: configuration)
    builder = session.associatedWorkoutBuilder()
} catch {
    // Handle failure here.
    return
}
```

:::message
`HKWorkoutSession`ã¯ä¾‹å¤–å‡¦ç†ã‚’æŠ•ã’ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€`do catch`ãŒå¿…è¦ã€‚
:::

## HKWorkoutSessionãƒ»HKLiveWorkoutBuilderã«ã¤ã„ã¦

`HKWorkoutSession`ãƒ»`HKLiveWorkoutBuilder`ã‚’ç”¨ã„ã¦ã€Workoutã®çŠ¶æ…‹ã‚„å¿ƒæ‹æ•°ã®ãƒ©ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿ãªã©ã‚’å–å¾—ã—ã¾ã™ã€‚

```swift
var session: HKWorkoutSession?
var builder: HKLiveWorkoutBuilder?
```

`HKWorkoutSession`ãƒ»`HKLiveWorkoutBuilder`ã®å½¹å‰²ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

`HKWorkoutSession`ï¼ˆSessionï¼‰:

- ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆå…¨ä½“ã®æœŸé–“ã¨çŠ¶æ…‹ã‚’ç®¡ç†ã—ã¾ã™ã€‚
- ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã®é–‹å§‹ã€ä¸€æ™‚åœæ­¢ã€å†é–‹ã€çµ‚äº†ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚
- ã‚¤ãƒ™ãƒ³ãƒˆã‚„ã‚¨ãƒ©ãƒ¼ã®é€šçŸ¥ã—ã¾ã™ã€‚

`HKLiveWorkoutBuilder`ï¼ˆBuilderï¼‰:

- ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã«åé›†ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®è¨˜éŒ²ã¨ç®¡ç†ã—ã¾ã™ã€‚
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«ã¨ã‚¤ãƒ™ãƒ³ãƒˆã®åé›†ã—ã¾ã™ã€‚

### Delegateã®è¨­å®š

```swift
session.delegate = self
builder.delegate = self
```

ã‚’å®Ÿè£…ã—ã€ãƒ‡ãƒªã‚²ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚è©³ç´°ã«é–¢ã—ã¦ã¯å¾Œè¿°ã„ãŸã—ã¾ã™ã€‚

### `HKLiveWorkoutDataSource`ã®ç”Ÿæˆ

`HKLiveWorkoutDataSource`ã¨ã¯ã€WorkoutSessionã‹ã‚‰ãƒ©ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ã™ã‚‹DataSourceã§ã™ã€‚`HKLiveWorkoutDataSource`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€builderã«å‰²ã‚Šå½“ã¦ã¾ã™ã€‚

```swift
builder.dataSource = HKLiveWorkoutDataSource(healthStore: healthStore,
                                             workoutConfiguration: configuration)
```

### Workoutã®Sessionã¨Builderã‚’é–‹å§‹

 Sessionã¨Builderã‚’é–‹å§‹ã—ã¾ã™ã€‚

```swift
// Start the workout session and begin data collection.
let startDate = Date()
session?.startActivity(with: startDate)
builder?.beginCollection(withStart: startDate) { (success, error) in
        // The workout has started.
}
```

## Workoutã®çŠ¶æ…‹ã®å¤‰æ›´

é‹å‹•å‰ãƒ»é‹å‹•ä¸­ãƒ»ä¼‘æ†©ä¸­ãƒ»çµ‚äº†ã‹ã®çŠ¶æ…‹ã‚’`HKWorkoutSession`ã§ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§Workoutã®çŠ¶æ…‹ã‚’æ“ä½œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- ä¸€æ™‚åœæ­¢

```swift
session?.pause()
```

- å†é–‹

```swift
session?.resume()
```

- çµ‚äº†

```swift
session?.end()
```

## Sessionã¨Builderã®çµ‚äº†

ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆãŒçµ‚äº†ã—ãŸå¾Œã«ã€Sessionã‚’çµ‚äº†ã—ã€Builderã®`endCollection(withEnd:completion:)`ãƒ»`finishWorkout(completion:)`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

### `endCollection(withEnd:completion:)`

- ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã®çµ‚äº†æ—¥æ™‚ã‚’è¨­å®šã—ã€ãƒ“ãƒ«ãƒ€ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã€‚
- å®Œäº†ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¯ã€çµ‚äº†å‡¦ç†ãŒæˆåŠŸã—ãŸã‹ã©ã†ã‹ã‚’ç¤ºã™ `success` ã¨ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã® `error` ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

### `finishWorkout(completion:)`

- ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã¨ãã®é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚’HealthKitStoreã«ä¿å­˜ã—ã¾ã™ã€‚
- å®Œäº†ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¯ã€workout([`HKWorkout`](https://developer.apple.com/documentation/healthkit/hkworkout)) ã¨ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã® `error` ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã€Sessionã¨Builderã®çµ‚äº†ã®å®Ÿè£…ä¾‹ã§ã™ã€‚

```swift
session.end()
builder.endCollection(withEnd: Date()) { (success, error) in
    
    guard success else {
        // Handle errors.
    }
    
    builder.finishWorkout { (workout, error) in
        
        guard workout != nil else {
            // Handle errors.
        }
        
        DispatchQueue.main.async() {
            // Update the user interface.
        }
    }
}
```

## Workoutã«é–¢é€£ã—ãŸDelegate

`HKWorkoutSessionDelegate`ã¨`HKLiveWorkoutBuilderDelegate`ãŒå­˜åœ¨ã—ã¾ã™ã€‚

- [`HKWorkoutSessionDelegate`](https://developer.apple.com/documentation/healthkit/hkworkoutsessiondelegate)ã¯ã€Sessionã®çŠ¶æ…‹ãŒå¤‰åŒ–ã—ãŸã¨ãã€ã¾ãŸã¯SessionãŒã‚¨ãƒ©ãƒ¼ã§å¤±æ•—ã—ãŸã¨ãã«æ›´æ–°ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

- [`HKLiveWorkoutBuilderDelegate`](https://developer.apple.com/documentation/healthkit/hkliveworkoutbuilderdelegate)ã¯ã€Builderã«æ–°ã—ã„ã‚µãƒ³ãƒ—ãƒ«ã‚„ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã—ãŸã¨ãã«æ›´æ–°ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

## HKWorkoutSessionDelegateã«ã¤ã„ã¦

### Workoutã®çŠ¶æ…‹ã‚’é€šçŸ¥ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå¿…é ˆï¼‰

å¿…é ˆã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚ã‚‹[`workoutSession(_:didChangeTo:from:date:)`](https://developer.apple.com/documentation/healthkit/hkworkoutsessiondelegate/1627958-workoutsession)ã§ã™ã€‚Workoutã®çŠ¶æ…‹ï¼ˆ[`HKWorkoutSessionState`](https://developer.apple.com/documentation/healthkit/hkworkoutsessionstate)ï¼‰ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«å‡¦ç†ã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚ä»¥ä¸‹ã€è¡¨ã§ã™ã€‚

| å¼•æ•°é …ç›® | èª¬æ˜ |
|------------|-----------|
| workoutSession   | å¤‰åŒ–ã—ãŸworkoutSessionã€‚|
| toState  | ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¤‰æ›´å¾Œã®çŠ¶æ…‹ã€‚[`HKWorkoutSessionState`](https://developer.apple.com/documentation/healthkit/hkworkoutsessionstate) |
| fromState  | ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¤‰æ›´å‰ã®çŠ¶æ…‹ã€‚[`HKWorkoutSessionState`](https://developer.apple.com/documentation/healthkit/hkworkoutsessionstate) |
| date   | çŠ¶æ…‹ã®å¤‰æ›´ãŒã„ã¤ç™ºç”Ÿã—ãŸã‹ã‚’ç¤ºã™Dateã€‚ |

`HKWorkoutSessionState`ã¯ã€WorkoutSessionã®çŠ¶æ…‹ã‚’è¡¨ã™åˆ—æŒ™å‹ã§ã™ã€‚ä»¥ä¸‹ã€è¡¨ã§ã™ã€‚

| çŠ¶æ…‹        | èª¬æ˜                                   |
|-------------|----------------------------------------|
| notStarted  | ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯é–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ |
| prepared    | ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯æº–å‚™ãŒã§ãã¦ã„ã¾ã™ãŒã€ã¾ã é–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ |
| running     | ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œä¸­ã§ã™ã€‚       |
| paused      | ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä¸€æ™‚åœæ­¢ã•ã‚Œã¾ã—ãŸã€‚ |
| stopped     | ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåœæ­¢ã—ã¾ã—ãŸã€‚               |
| ended       | ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚    |

`stopped`ã€`ended`ã®é•ã„ã¯ã€

- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å†é–‹ãƒ»å†åˆ©ç”¨ã§ããªã„ã€‚
- ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ãªããªã‚‹ã€‚

ã“ã¨ã¯å…±é€šã—ã¦ã„ã¾ã™ã€‚ç•°ãªã‚‹ç‚¹ã¨ã—ã¦ã€`stopped`ã¯ã‚¢ãƒ—ãƒªã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å‹•ä½œã—ç¶šã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€`ended`ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚‚åœæ­¢ã•ã‚Œã¾ã™ã€‚

### Workoutã®Sessionã®å¤±æ•—ã‚’é€šçŸ¥ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå¿…é ˆï¼‰

å¿…é ˆã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚ã‚‹`workoutSession(_:didFailWithError:)`ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯Sessionã®ç”Ÿæˆãƒ»çŠ¶æ…‹ç®¡ç†ãŒå¤±æ•—ã—ãŸå ´åˆã«é€šçŸ¥ã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚ä»¥ä¸‹ã€è¡¨ã§ã™ã€‚

| é …ç›®             | èª¬æ˜                                       |
|------------------|--------------------------------------------|
| workoutSession   | å¤±æ•—ã—ãŸ[`HKWorkoutSession`](https://developer.apple.com/documentation/healthkit/hkworkoutsession)             |
| error            | å¤±æ•—ã‚’ã«é–¢ã™ã‚‹`Error`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ           |

## HKLiveWorkoutBuilderDelegateã«ã¤ã„ã¦

### æ–°ã—ã„ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ãƒ‡ãƒ¼ã‚¿ãŒè¿½åŠ ã•ã‚ŒãŸã“ã¨ã‚’é€šçŸ¥ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå¿…é ˆï¼‰

å¿…é ˆã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚ã‚‹`workoutBuilder(_:didCollectDataOf:)`ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒãƒ“ãƒ«ãƒ€ã«è¿½åŠ ã•ã‚ŒãŸã“ã¨ã‚’é€šçŸ¥ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚

| å¼•æ•°å   | å‹  | èª¬æ˜ |
|----|------|----|
| workoutBuilder    | `HKLiveWorkoutBuilder`    | ã‚¤ãƒ™ãƒ³ãƒˆã‚’åé›†ã—ãŸ`HKLiveWorkoutBuilder`ã€‚ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã®è©³ç´°ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚     |
| collectedTypes    | `Set<HKSampleType>`       | åé›†ã•ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿å‹ã®é›†åˆã€‚`HKSampleType`ã®é›†åˆã§ã‚ã‚Šã€ç‰¹å®šã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿å‹ã‚’ç¤ºã—ã¾ã™ã€‚ |

ä½¿ç”¨ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

```swift
    func workoutBuilder(_ workoutBuilder: HKLiveWorkoutBuilder, didCollectDataOf collectedTypes: Set<HKSampleType>) {
        for type in collectedTypes {
            guard let quantityType = type as? HKQuantityType else {
                return // Nothing to do.
            }

            let statistics = workoutBuilder.statistics(for: quantityType)

            // Update the published values.
            updateForStatistics(statistics)
        }
    }
```

å‡¦ç†ã‚’è¿½ã£ã¦ã„ãã¾ã™ã€‚

```swift
for type in collectedTypes {
// çœç•¥
}
```

collectedTypeså†…ã«å­˜åœ¨ã™ã‚‹é€šçŸ¥ã•ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®é›†åˆã‚’å…¨ã¦`foræ–‡`ã§å‡¦ç†ã™ã‚‹ã€‚

```swift
let statistics = workoutBuilder.statistics(for: quantityType)
```

å„ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ã‚’å¼•æ•°ã«è¨­å®šã—ã¦ã€workoutBuilderã«å­˜åœ¨ã™ã‚‹ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã€‚

```swift
 // Update the published values.
updateForStatistics(statistics)
```

å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç”¨ã„ã¦ã€UIã«é–¢é€£ã™ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ›´æ–°ã™ã‚‹ã€‚

### æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚ŒãŸã“ã¨ã‚’é€šçŸ¥ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå¿…é ˆï¼‰

å¿…é ˆã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚ã‚‹`workoutBuilderDidCollectEvent(_:)`ãŒã‚ã‚Šã¾ã™ã€‚æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãŒãƒ“ãƒ«ãƒ€ã«è¿½åŠ ã•ã‚ŒãŸã“ã¨ã‚’é€šçŸ¥ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚

```swift
let lastEvent = workoutBuilder.workoutEvents.last
```

ä¸Šè¨˜ã®å®Ÿè£…ã§ãƒ“ãƒ«ãƒ€ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã§ãã¾ã™ã€‚ã‚¤ãƒ™ãƒ³ãƒˆã¯[`HKWorkoutEvent`](https://developer.apple.com/documentation/healthkit/hkworkoutevent)ã§è¡¨ã•ã‚Œã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã§ãã¾ã™ã€‚ä»¥ä¸‹ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒªã‚¹ãƒˆã§ã™ã€‚

| å¤‰æ•°å  | å‹   | èª¬æ˜    |
| ------ | ---------- | --- |
| `dateInterval` | `DateInterval`  | ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“ã¨æœŸé–“    |
| `type`    | `HKWorkoutEventType`  | ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡ |
| `metadata`  | `[String : Any]?`   | ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã«é–¢é€£ã™ã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ |

- `dateInterval`ã¯`HKWorkoutEventType.lap` ãŠã‚ˆã³ `HKWorkoutEventType.segment`ã®ã¿æ—¥æ™‚é–“éš”ã‚’å«ã‚€`DateInterval`ã‚’å–å¾—ã§ãã‚‹ã€‚ãã‚Œä»¥å¤–ã®Eventã«é–¢ã—ã¦ã¯ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸæ™‚ç‚¹ã®ç¤ºã™`dateInterval`ï¼ˆæ—¥æ™‚é–“éš”ãŒ0ï¼‰ã®å€¤ã‚’å–å¾—ã§ãã¾ã™ã€‚

- `type`ã¯[`HKWorkoutEventType`](https://developer.apple.com/documentation/healthkit/hkworkouteventtype)ã§ã™ã€‚ä»¥ä¸‹ã€è¡¨ã§ã™ã€‚

| ã‚¤ãƒ™ãƒ³ãƒˆå| èª¬æ˜|
| ---- | --------- |
| `pause`| ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆãŒä¸€æ™‚åœæ­¢ã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã™å®šæ•°|
| `resume`| ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆãŒå†é–‹ã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã™å®šæ•°|
| `motionPaused`| ã‚·ã‚¹ãƒ†ãƒ ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•çš„ã«ä¸€æ™‚åœæ­¢ã—ãŸã“ã¨ã‚’ç¤ºã™å®šæ•°   |
| `motionResumed`| ã‚·ã‚¹ãƒ†ãƒ ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•çš„ã«å†é–‹ã—ãŸã“ã¨ã‚’ç¤ºã™å®šæ•°|
| `pauseOrResumeRequest`  | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¸€æ™‚åœæ­¢ã¾ãŸã¯å†é–‹ã‚’è¦æ±‚ã—ãŸã“ã¨ã‚’ç¤ºã™å®šæ•°|
| `lap`                   | ãƒ©ãƒƒãƒ—ã‚’ç¤ºã™å®šæ•°|
| `segment`               | ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆä¸­ã®æ³¨ç›®ã™ã¹ãæœŸé–“ã‚’ç¤ºã™å®šæ•°|
| `marker`                | ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆä¸­ã®æ³¨ç›®ã™ã¹ããƒã‚¤ãƒ³ãƒˆã‚’ç¤ºã™å®šæ•°|

ä¾‹ã¨ã—ã¦ã€`HKWorkoutEventType.lap`ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸã‚‰ã€ãƒ©ãƒƒãƒ—æ•°ã®UIã‚’æ›´æ–°ã™ã‚‹ãªã©ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

## ãã®ä»–

- iOSã¨WatchOSã‚’åŒæœŸã•ã›ã¦Workoutã‚’ç®¡ç†
- Workoutä¸­ã«ç”Ÿã˜ãŸã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‹ã‚‰ã®ãƒªã‚«ãƒãƒªãƒ¼æ–¹æ³•

ä¸Šè¨˜ã«é–¢ã—ã¦å…¬å¼ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ãŒã€ä»Šå›ã®è¨˜äº‹ã§ã¯çœãã¾ã™ã€‚ä»¥ä¸‹ã®å…¬å¼ã«è¨˜è¼‰ã‚ã‚Šã¾ã™ã®ã§ã€å‚è€ƒã¾ã§ã«ã”è¦§ãã ã•ã„ã€‚

https://developer.apple.com/documentation/healthkit/workouts_and_activity_rings/running_workout_sessions#2962487

WorkoutSessionã«é–¢é€£ã—ãŸä¸»ãªå®Ÿè£…ã¯ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚

## æœ€å¾Œã«

é–“é•ã„ãƒ»æ°—ã«ãªã‚‹éƒ¨åˆ†ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ã‚³ãƒ¡ãƒ³ãƒˆã„ãŸã ã‘ã‚‹ã¨å¤§å¤‰ã†ã‚Œã—ã„ã§ã™ã€‚
è‰¯ã‹ã£ãŸã¨æ€ã£ãŸã‚‰**è¨˜äº‹ã¸ã®ã„ã„ã­**ã€**Xã®ãƒ•ã‚©ãƒ­ãƒ¼**ã‚’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

https://sites.google.com/view/muranakar

å€‹äººã§ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚è‰¯ã‹ã£ãŸã‚‰è¦—ã„ã¦ã¿ã¦ãã ã•ã„ã€‚