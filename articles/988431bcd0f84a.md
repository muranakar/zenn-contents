---
title: "SQLiteã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’çµ„ã¿è¾¼ã‚€æ–¹æ³•"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Flutter, Dart, SQlite]
published: true
published_at: 2025-01-27 07:00 # æœªæ¥ã®æ—¥æ™‚ã‚’æŒ‡å®šã™ã‚‹
---

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’çµ„ã¿è¾¼ã‚€æ–¹æ³•

## 1. ã‚¢ã‚»ãƒƒãƒˆã®æº–å‚™

ã¾ãšã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```
assets/example.db
```

`pubspec.yaml`ã«ã‚¢ã‚»ãƒƒãƒˆã‚’ç™»éŒ²ã—ã¾ã™ï¼š

```yaml:pubspec.yaml
flutter:
  assets:
    - assets/example.db
```

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–ã®å®Ÿè£…

åˆå›èµ·å‹•æ™‚ã®ã¿ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹æ–¹æ³•ã§ã™ã€‚

```dart:performance_database.dart
// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
Future<Database> initPerformanceDatabase() async {
  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‘ã‚¹ã‚’å–å¾—
  var databasesPath = await getDatabasesPath();
  var path = join(databasesPath, "demo_asset_example.db");

  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å­˜åœ¨ç¢ºèª
  var exists = await databaseExists(path);

  if (!exists) {
    print("æ–°è¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™");

    try {
      // è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
      await Directory(dirname(path)).create(recursive: true);

      // ã‚¢ã‚»ãƒƒãƒˆã‹ã‚‰ã‚³ãƒ”ãƒ¼
      ByteData data = await rootBundle.load(url.join("assets", "example.db"));
      List<int> bytes = data.buffer.asUint8List(data.offsetInBytes, data.lengthInBytes);

      // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸ãè¾¼ã¿
      await File(path).writeAsBytes(bytes, flush: true);
    } catch (e) {
      print("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: $e");
    }
  }

  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‹ã
  return await openDatabase(path, readOnly: true);
}
```

### æ¯å›æ–°è¦ã‚³ãƒ”ãƒ¼ã™ã‚‹å®Ÿè£…

ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«å¿…ãšæ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹æ–¹æ³•ã§ã™ã€‚æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚‹æ‰‹é †ãŒå¿…è¦ã§ã™ã€‚

```dart:fresh_copy_database.dart
// æ¯å›æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹é–¢æ•°
Future<Database> initFreshDatabase() async {
  var databasesPath = await getDatabasesPath();
  var path = join(databasesPath, "demo_fresh_copy.db");

  // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å‰Šé™¤
  await deleteDatabase(path);

  try {
    // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
    await Directory(dirname(path)).create(recursive: true);

    // ã‚¢ã‚»ãƒƒãƒˆã‹ã‚‰ã‚³ãƒ”ãƒ¼
    ByteData data = await rootBundle.load(url.join("assets", "example.db"));
    List<int> bytes = data.buffer.asUint8List(data.offsetInBytes, data.lengthInBytes);
    await File(path).writeAsBytes(bytes, flush: true);
  } catch (e) {
    print("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: $e");
  }

  return await openDatabase(path, readOnly: true);
}
```

### ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†æ©Ÿèƒ½ä»˜ãã®å®Ÿè£…

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç®¡ç†ã™ã‚‹æ–¹æ³•ã§ã™ã€‚
æ—¢å­˜ DB ã¨ AssetDB ã€€ã® Version ã‚’æ¯”è¼ƒã—ã¦ã€DB ã‚’è¿½åŠ ãƒ»å¤‰æ›´ã—ãŸã„å ´åˆã«ä½¿ç”¨ã™ã‚‹ã€‚

```dart:versioned_database.dart
// ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ä»˜ããƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–é–¢æ•°
Future<Database> initVersionedDatabase({
  required String databasesPath,
  required String versionNumFilename,
  required String dbFilename
}) async {
  var dbPath = join(databasesPath, dbFilename);
  var versionNumFile = File(join(databasesPath, versionNumFilename));

  // ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
  var existingVersionNum = 0;
  if (versionNumFile.existsSync()) {
    existingVersionNum = int.parse(await versionNumFile.readAsString());
  }

  // ã‚¢ã‚»ãƒƒãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—
  var assetVersionNum = int.parse(
    (await rootBundle.loadString(url.join('assets', versionNumFilename))).trim()
  );

  // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒã¨ã‚³ãƒ”ãƒ¼
  if (existingVersionNum < assetVersionNum) {
    try {
      await Directory(databasesPath).create(recursive: true);

      var data = await rootBundle.load(url.join('assets', dbFilename));
      var bytes = Uint8List.sublistView(data);

      await File(dbPath).writeAsBytes(bytes, flush: true);
      await versionNumFile.writeAsString('$assetVersionNum', flush: true);
    } catch (e) {
      print("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: $e");
    }
  }

  return await openDatabase(dbPath);
}
```

## ä½¿ã„åˆ†ã‘ã®ãƒã‚¤ãƒ³ãƒˆ

1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–ã®å®Ÿè£…**

   - ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’æœ€å°é™ã«æŠ‘ãˆãŸã„å ´åˆ
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ›´æ–°é »åº¦ãŒä½ã„å ´åˆ

2. **æ¯å›æ–°è¦ã‚³ãƒ”ãƒ¼ã®å®Ÿè£…**

   - å¸¸ã«æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ãŸã„å ´åˆ
   - ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ä½¿ç”¨ã™ã‚‹å ´åˆ

3. **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†æ©Ÿèƒ½ä»˜ãã®å®Ÿè£…**
   - ã‚¢ãƒ—ãƒªã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚‚æ›´æ–°ã™ã‚‹å ´åˆ
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å¤‰æ›´å±¥æ­´ã‚’ç®¡ç†ã—ãŸã„å ´åˆ

## å‚ç…§

https://github.com/tekartik/sqflite/blob/master/sqflite/doc/opening_asset_db.md
