---
title: "SwiftDataの紹介と活用方法"
emoji: "🙆"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [iOS,Swift,SwiftUI,SwiftData]
published: false
---

![](/images/2024-06-23-21-20-20.png)

![](/images/2024-06-23-21-20-33.png)


![](/images/2024-06-23-21-20-44.png)

![](/images/2024-06-23-21-21-51.png)


![](/images/2024-06-23-21-22-24.png)

![](/images/2024-06-23-21-22-41.png)

![](/images/2024-06-23-21-22-54.png)

![](/images/2024-06-23-21-23-10.png)

![](/images/2024-06-23-21-23-31.png)

![](/images/2024-06-23-21-24-20.png)

![](/images/2024-06-23-21-24-30.png)

![](/images/2024-06-23-21-24-43.png)

![](/images/2024-06-23-21-28-22.png)

![](/images/2024-06-23-21-28-47.png)

![](/images/2024-06-23-21-29-05.png)

![](/images/2024-06-23-21-29-22.png)

![](/images/2024-06-23-21-30-04.png)

![](/images/2024-06-23-21-30-24.png)

![](/images/2024-06-23-21-30-38.png)

![](/images/2024-06-23-21-31-06.png)

![](/images/2024-06-23-21-31-24.png)

![](/images/2024-06-23-21-31-35.png)

![](/images/2024-06-23-21-31-56.png)

![](/images/2024-06-23-21-32-25.png)



了解しました。コメントアウトを増やして、コードの説明を詳しくします。

# SwiftDataの紹介と活用方法

## はじめに
こんにちは、AppleのSwiftDataチームのエンジニア、Nick Gillettです。このセッションでは、新しい強力なフレームワークSwiftDataを活用してアプリケーションを構築する方法について詳しく説明します。まず、アプリケーションでの永続化の設定方法を見ていきます。次に、ModelContextを使用して変更を追跡し永続化する方法について説明します。最後に、コード内でオブジェクトを操作する際にSwiftDataを最大限に活用する方法を紹介します。

## 永続化の設定
### モデルの定義

SwiftDataでは、データを永続化するための基本単位としてModelを使用します。以下は、SampleTripsアプリケーションのTripクラスの定義例です。

```swift
// @Modelアノテーションを使って、SwiftDataに永続化するクラスであることを示します
@Model
final class Trip {
    // 旅行の目的地
    var destination: String?
    // 旅行の終了日
    var end_date: Date?
    // 旅行の名前
    var name: String?
    // 旅行の開始日
    var start_date: Date?
    
    // バケットリストアイテムとの関係（カスケード削除）
    @Relationship(.cascade)
    var bucketListItem: [BucketListItem] = [BucketListItem]()
    
    // 宿泊施設との関係（カスケード削除）
    @Relationship(.cascade)
    var livingAccommodation: LivingAccommodation?
}
```

### ModelContainerの初期化

ModelContainerはデータの永続化を管理します。以下の例では、Tripクラスだけを使用してModelContainerを初期化しています。

```swift
// Tripクラスを使ってModelContainerを初期化
let container = try ModelContainer(for: Trip.self)
```

SwiftDataは関連するモデルクラスも自動的に推論します。

```swift
// 複数のモデルクラスを使ってModelContainerを初期化
let container = try ModelContainer(
    for: [
        Trip.self, 
        BucketListItem.self, 
        LivingAccommodation.self
    ]
)
```

### ModelConfigurationの使用

ModelConfigurationを使用してModelContainerをカスタマイズできます。例えば、以下のように複数のスキーマとファイルURLを指定してModelContainerを作成します。

```swift
// 全体のスキーマを定義
let fullSchema = Schema([
    Trip.self,
    BucketListItem.self,
    LivingAccommodations.self,
    Person.self,
    Address.self
])

// Trip関連のデータの永続化設定
let trips = ModelConfiguration(
    schema: Schema([
        Trip.self,
        BucketListItem.self,
        LivingAccommodations.self
    ]),
    url: URL(filePath: "/path/to/trip.store"),
    cloudKitContainerIdentifier: "com.example.trips"
)

// Person関連のデータの永続化設定
let people = ModelConfiguration(
    schema: Schema([Person.self, Address.self]),
    url: URL(filePath: "/path/to/people.store"),
    cloudKitContainerIdentifier: "com.example.people"
) 

// 複数の設定を使ってModelContainerを初期化
let container = try ModelContainer(for: fullSchema, trips, people)
```

## SwiftUIでのModelContainerの使用
SwiftUIアプリケーションでは、`modelContainer`修飾子を使用してModelContainerを簡単に作成できます。

```swift
@main
struct TripsApp: App {
    var body: some Scene {
        WindowGroup {
            ContentView()
        }
        // modelContainer修飾子を使用してModelContainerを作成
        .modelContainer(for: Trip.self)
    }
}
```

### ModelContextの参照
SwiftUIのビューでModelContextを参照する例です。

```swift
struct ContentView: View {
    // Tripオブジェクトの配列をクエリ
    @Query var trips: [Trip]
    // 環境からModelContextを取得
    @Environment(\.modelContext) var modelContext
    
    var body: some View {
        NavigationStack {
            List {
                // 旅行リストを表示
                ForEach(trips) { trip in
                    TripListItem(trip: trip)
                        .swipeActions(edge: .trailing) {
                            Button(role: .destructive) {
                                // モデルコンテキストから旅行を削除
                                modelContext.delete(trip)
                            } label: {
                                Label("Delete", systemImage: "trash")
                            }
                        }
                }
                .onDelete(perform: deleteTrips(at:))
            }
        }
    }
}
```

## 高度な機能
### FetchDescriptorの使用
FetchDescriptorを使用してオブジェクトを取得する例です。

```swift
// 新しいSwiftContextを作成し、Tripオブジェクトを取得
let context = self.newSwiftContext(from: Trip.self)
var trips = try context.fetch(FetchDescriptor<Trip>())
```

### Predicateマクロを使ったクエリ

```swift
// 新しいSwiftContextを作成
let context = self.newSwiftContext(from: Trip.self)
// ホテル名のリスト
let hotelNames = ["First", "Second", "Third"]

// Predicateマクロを使ってフィルタ条件を定義
var predicate = #Predicate<Trip> { trip in
    trip.livingAccommodations.filter {
        hotelNames.contains($0.placeName)
    }.count > 0
}

// FetchDescriptorにPredicateを設定してクエリを実行
var descriptor = FetchDescriptor(predicate: predicate)
var trips = try context.fetch(descriptor)
```

### オブジェクトの列挙

```swift
// FetchDescriptorを使用してオブジェクトを列挙
context.enumerate(FetchDescriptor<Trip>()) { trip in
    // tripオブジェクトに対して操作を行う
}
```

### SortDescriptorを使った列挙

```swift
// Predicateマクロを使ってフィルタ条件を定義
let predicate = #Predicate<Trip> { trip in
    trip.bucketListItem.filter {
        $0.hasReservation == false
    }.count > 0
}

// FetchDescriptorにPredicateとSortDescriptorを設定してクエリを実行
let descriptor = FetchDescriptor(predicate: predicate)
descriptor.sortBy = [SortDescriptor(\.start_date)]

// オブジェクトを列挙して処理を実行
context.enumerate(descriptor) { trip in
    // tripに対してリマインダー設定などの操作を行う
}
```

### バッチサイズとallowEscapingMutationsの調整

```swift
// Predicateマクロを使ってフィルタ条件を定義
let predicate = #Predicate<Trip> { trip in
    trip.bucketListItem.filter {
        $0.hasReservation == false
    }.count > 0
}

// FetchDescriptorにPredicateとSortDescriptorを設定
let descriptor = FetchDescriptor(predicate: predicate)
descriptor.sortBy = [SortDescriptor(\.start_date)]

// バッチサイズとallowEscapingMutationsを設定してオブジェクトを列挙
context.enumerate(
    descriptor,
    batchSize: 500,
    allowEscapingMutations: true
) { trip in
    // tripに対してリマインダー設定などの操作を行う
}
```

## まとめ
このセッションでは、SchemaとModelConfigurationを使用して強力な永続化設定を作成する方法を学びました。また、ModelContainerとModelContextを使用して標準的なシステム機能を簡単に採用する方法も紹介しました。SwiftDataを使用することで、安全で高性能なコードを簡単に書くことができます。SwiftDataの新しいフレームワークを使用して、プロジェクトでどのように活用できるかを楽しみにしています。

以上、SwiftDataの紹介と活用方法についての技術記事でした。Happy Coding!