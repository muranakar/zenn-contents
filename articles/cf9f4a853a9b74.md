---
title: "ã€WWDC23ã€‘SwiftDataã®è©³ç´°è¨­å®š"
emoji: "ğŸ’¾"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [iOS,Swift,SwiftUI,SwiftData]
published: true
---

## ã¯ã˜ã‚ã«

SwiftDataã‚’æ´»ç”¨ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

- ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ã®è¨­å®š
- ModelContainerã®è¨­å®š
- æ¡ä»¶ã‚’æŒ‡å®šã—ãŸã‚¯ã‚¨ãƒªæ©Ÿèƒ½

ã®é †ã«èª¬æ˜ã—ã¾ã™ã€‚

## æ°¸ç¶šåŒ–ã®è¨­å®š

### ãƒ¢ãƒ‡ãƒ«ã®å®šç¾©

SwiftDataã§ã¯ã€Swiftã§ã™ã§ã«å­˜åœ¨ã™ã‚‹`struct`ãƒ»`class`ã‚’ç”¨ã„ã¦æ´»ç”¨ã§ãã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šåŒ–ã™ã‚‹ãŸã‚ã®åŸºæœ¬å˜ä½ã¨ã—ã¦`Model`ãƒã‚¯ãƒ­ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ä»¥ä¸‹ã¯ã€SampleTripsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®`Trip`ã‚¯ãƒ©ã‚¹ã®å®šç¾©ä¾‹ã§ã™ã€‚

```swift
// @Modelãƒã‚¯ãƒ­ã‚’ä½¿ã£ã¦ã€SwiftDataã«æ°¸ç¶šåŒ–ã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™
@Model
final class Trip {
    var destination: String?
    var end_date: Date?
    var name: String?
    var start_date: Date?
    
    // ãƒã‚±ãƒƒãƒˆãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã¨ã®é–¢ä¿‚ï¼ˆã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤ï¼‰
    @Relationship(.cascade)
    var bucketListItem: [BucketListItem] = [BucketListItem]()
    
    // å®¿æ³Šæ–½è¨­ã¨ã®é–¢ä¿‚ï¼ˆã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤ï¼‰
    @Relationship(.cascade)
    var livingAccommodation: LivingAccommodation?
}
```

`@Relationship()`ã‚’ç”¨ã„ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ä»–ã«ãƒ¢ãƒ‡ãƒ«å®šç¾©ã¨ã®é–¢ä¿‚æ€§ã‚’å®šç¾©ã§ãã¾ã™ã€‚

### ModelContainerã®åˆæœŸåŒ–

![](/images/2024-06-23-21-21-51.png)

ã‚¹ã‚­ãƒ¼ãƒã¯`ModelContainer`ã¨å‘¼ã°ã‚Œã‚‹ã‚¯ãƒ©ã‚¹ã«é©å¿œã•ã‚Œã€ãƒ‡ãƒ¼ã‚¿ãŒã©ã®ã‚ˆã†ã«æ°¸ç¶šåŒ–ã™ã‚‹ã‹ã‚’è¨˜è¿°ã—ã¾ã™ã€‚`ModelContainer`ã¯ã‚¹ã‚­ãƒ¼ãƒã‚’èª­ã¿å–ã£ã¦ã€Modelã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

![](/images/2024-06-23-21-22-24.png)

ã‚³ãƒ¼ãƒ‰å†…ã§Modelã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ‰±ã†å ´åˆã¯ã€ãã‚Œã‚‰ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ãƒ¡ãƒ¢ãƒªå†…ã®çŠ¶æ…‹ã‚’è¿½è·¡ã—ã€ç®¡ç†ã™ã‚‹`ModelContext`ã«ãƒªãƒ³ã‚¯ã•ã‚Œã¾ã™ã€‚

ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€Tripã‚¯ãƒ©ã‚¹ã ã‘ã‚’ä½¿ç”¨ã—ã¦ModelContainerã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™ã€‚

```swift
// Tripã‚¯ãƒ©ã‚¹ã‚’ä½¿ã£ã¦ModelContainerã‚’åˆæœŸåŒ–
let container = try ModelContainer(for: Trip.self)
```

ä¸Šè¨˜ã®å®Ÿè£…ã®ã¿ã§å•é¡Œã¯ãªã„ã§ã™ã€‚ãã®ä»–ã®é–¢é€£ã—ãŸã‚¹ã‚­ãƒ¼ãƒ(`BucketListItem`,`LivingAccommodation`)ã‚‚æ¨æ¸¬ã—ã¦è‡ªå‹•ã§å®šç¾©ã•ã‚Œã¾ã™ã€‚

### ModelConfigurationã®ä½¿ç”¨

`ModelConfiguration`ã‚’ä½¿ç”¨ã—ã¦`ModelContainer`ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜å…ˆ(ãƒ¡ãƒ¢ãƒªorãƒ‡ã‚£ã‚¹ã‚¯ãªã©)ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¤‡æ•°ã®ã‚¹ã‚­ãƒ¼ãƒã¨ãƒ•ã‚¡ã‚¤ãƒ«URLã‚’æŒ‡å®šã—ã¦`ModelContainer`ã‚’ä½œæˆã§ãã¾ã™ã€‚

```swift
// å…¨ä½“ã®ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©
let fullSchema = Schema([
    Trip.self,
    BucketListItem.self,
    LivingAccommodations.self,
    Person.self,
    Address.self
])

// Tripé–¢é€£ã®ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–è¨­å®š
let trips = ModelConfiguration(
    schema: Schema([
        Trip.self,
        BucketListItem.self,
        LivingAccommodations.self
    ]),
    url: URL(filePath: "/path/to/trip.store"),
    cloudKitContainerIdentifier: "com.example.trips"
)

// Personé–¢é€£ã®ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–è¨­å®š
let people = ModelConfiguration(
    schema: Schema([Person.self, Address.self]),
    url: URL(filePath: "/path/to/people.store"),
    cloudKitContainerIdentifier: "com.example.people"
) 

// è¤‡æ•°ã®è¨­å®šã‚’ä½¿ã£ã¦ModelContainerã‚’åˆæœŸåŒ–
let container = try ModelContainer(for: fullSchema, trips, people)
```

ä»–ã«ã‚‚ã€èª­ã¿è¾¼ã¿åˆ¶é™ãƒ»ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã®é€£æºãªã©ã‚’ç°¡å˜ã«è¨­å®šã§ãã¾ã™ã€‚

## SwiftUIã§ã®ModelContainerã®ä½¿ç”¨

SwiftUIã§ã¯ã€`modelContainer`ãƒ¢ãƒ‡ã‚£ãƒ•ã‚¡ã‚¤ã‚¢ã‚’ä½¿ç”¨ã—ã¦`ModelContainer`ã‚’ç°¡å˜ã«ä½œæˆã§ãã¾ã™ã€‚

```swift
@main
struct TripsApp: App {
    var body: some Scene {
        WindowGroup {
            ContentView()
        }
        // modelContainerãƒ¢ãƒ‡ã‚£ãƒ•ã‚¡ã‚¤ã‚¢ã‚’ä½¿ç”¨ã—ã¦ModelContainerã‚’ä½œæˆ
        .modelContainer(for: Trip.self)
    }
}
```

### ModelContextã®å‚ç…§

SwiftUIã®ãƒ“ãƒ¥ãƒ¼ã§`ModelContext`ã‚’å‚ç…§ã—ã€CRUDå‡¦ç†ã‚’ç°¡å˜ã«å®Ÿè£…å¯èƒ½ã§ã™ã€‚

```swift
struct ContentView: View {
    @Query var trips: [Trip]
    // ModelContextã‚’å–å¾—
    @Environment(\.modelContext) var modelContext
    
    var body: some View {
        NavigationStack {
            List {
                // æ—…è¡Œãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                ForEach(trips) { trip in
                    TripListItem(trip: trip)
                        .swipeActions(edge: .trailing) {
                            Button(role: .destructive) {
                                // modelContextã‹ã‚‰æ—…è¡Œã‚’å‰Šé™¤
                                modelContext.delete(trip)
                            } label: {
                                Label("Delete", systemImage: "trash")
                            }
                        }
                }
                .onDelete(perform: deleteTrips(at:))
            }
        }
    }
}
```

[`modelContainer(for:inMemory:isAutosaveEnabled:isUndoEnabled:onSetup:)`](https://developer.apple.com/documentation/SwiftUI/View/modelContainer(for:inMemory:isAutosaveEnabled:isUndoEnabled:onSetup:)-18hhy)ãƒ¢ãƒ‡ã‚£ãƒ•ã‚¡ã‚¤ã‚¢ãŒå­˜åœ¨ã—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’è¨­å®šã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€æŸ”è»Ÿãªãƒ‡ãƒ¼ã‚¿ç®¡ç†ãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

| é …ç›®å     | èª¬æ˜ |
|-----|---|
| modelType            | ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—                         |
| inMemory             | ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¢ãƒªå†…ã®ã¿ã«ä¿å­˜ã™ã‚‹ã‹ã©ã†ã‹                                      |
| isAutosaveEnabled    | ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ãŒæœ‰åŠ¹ã‹ã©ã†ã‹                                             |
| isUndoEnabled        | å…ƒã«æˆ»ã™æ“ä½œã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®undoManagerã‚’ä½¿ç”¨ã™ã‚‹ã‹ã©ã†ã‹       |
| onSetup              | ã‚³ãƒ³ãƒ†ãƒŠã®ä½œæˆãŒæˆåŠŸã¾ãŸã¯å¤±æ•—ã—ãŸã¨ãã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ |

- `isUndoEnabled`ã‚’trueã«è¨­å®šã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€è¿½åŠ ã‚³ãƒ¼ãƒ‰ç„¡ã—ã§å¤‰æ›´ã‚’å–ã‚Šæ¶ˆã—ã§ãã¾ã™ã€‚3æœ¬æŒ‡ã§ã‚¹ãƒ¯ã‚¤ãƒ—orã‚·ã‚§ã‚¤ã‚¯ãªã©ã®ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã§å¯èƒ½ã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯falseã§ã™ã€‚
- `isAutosaveEnabled`ã¯ã‚’trueã«è¨­å®šã•ã‚Œã¦ãŠã‚Šã€ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã¸ç§»å‹•ãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã«å¿œã˜ã¦è‡ªå‹•ã§`Context`ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯trueã§ã™ã€‚

## æ¡ä»¶ã‚’æŒ‡å®šã—ãŸã‚¯ã‚¨ãƒªæ©Ÿèƒ½

### Predicateãƒã‚¯ãƒ­ã‚’ä½¿ã£ãŸã‚¯ã‚¨ãƒª

`Predicate`ã¯Swiftã®æ§‹æ–‡ã§ã‚¯ã‚¨ãƒªã‚’è¨˜å…¥ã§ãã¾ã™ã€‚

```swift
let context = self.newSwiftContext(from: Trip.self)
let hotelNames = ["First", "Second", "Third"]

// Predicateãƒã‚¯ãƒ­ã‚’ä½¿ã£ã¦ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã‚’å®šç¾©
var predicate = #Predicate<Trip> { trip in
    trip.livingAccommodations.filter {
        hotelNames.contains($0.placeName)
    }.count > 0
}
```

[`FetchDescriptor`](https://developer.apple.com/documentation/swiftdata/fetchdescriptor)ã«`Predicate`ã®æ¡ä»¶
ã‚„[`SortDescriptor`](https://developer.apple.com/documentation/foundation/sortdescriptor)ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€å–å¾—ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã®æŒ‡å®šã‚„ä¸¦ã³æ›¿ãˆãŒå¯èƒ½ã§ã™ã€‚

```swift
// FetchDescriptorã«Predicateã‚’è¨­å®šã—ã¦ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
var descriptor = FetchDescriptor(predicate: predicate)
var trips = try context.fetch(descriptor)
```

[`enumerate(_:batchSize:allowEscapingMutations:block:)`](https://developer.apple.com/documentation/swiftdata/modelcontext/enumerate(_:batchsize:allowescapingmutations:block:))ã‚’ç”¨ã„ã¦ã€å–å¾—ãƒ‡ãƒ¼ã‚¿ã®åˆ—æŒ™ã‚‚ã§ãã¾ã™ã€‚

```swift
// FetchDescriptorã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ—æŒ™
context.enumerate(FetchDescriptor<Trip>()) { trip in
    // tripã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã—ã¦æ“ä½œã‚’è¡Œã†
}
```

[`enumerate(_:batchSize:allowEscapingMutations:block:)`](https://developer.apple.com/documentation/swiftdata/modelcontext/enumerate(_:batchsize:allowescapingmutations:block:))ã‚’ç”¨ã„ã‚‹ã¨

- ãƒãƒƒãƒã‚µã‚¤ã‚ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯5000ï¼‰
- allowEscapingMutationsï¼ˆãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã«ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ãŒè¨±å¯ã•ã‚Œã‚‹ã‹ã©ã†ã‹ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯falseï¼‰
  
ã‚’æŒ‡å®šã§ãã¾ã™ã€‚

```swift
context.enumerate(
    descriptor,
    batchSize: 500,
    allowEscapingMutations: true
) { trip in
    
}
```

## å‚è€ƒè³‡æ–™

https://developer.apple.com/videos/play/wwdc2023/10196/

## æœ€å¾Œã«

é–“é•ã„ãƒ»æ°—ã«ãªã‚‹éƒ¨åˆ†ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ã‚³ãƒ¡ãƒ³ãƒˆã„ãŸã ã‘ã‚‹ã¨å¤§å¤‰ã†ã‚Œã—ã„ã§ã™ã€‚
è‰¯ã‹ã£ãŸã¨æ€ã£ãŸã‚‰**è¨˜äº‹ã¸ã®ã„ã„ã­**ã€**Xã®ãƒ•ã‚©ãƒ­ãƒ¼**ã‚’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

https://sites.google.com/view/muranakar

å€‹äººã§ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚è‰¯ã‹ã£ãŸã‚‰è¦—ã„ã¦ã¿ã¦ãã ã•ã„ã€‚