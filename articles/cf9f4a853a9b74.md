---
title: "SwiftDataã®ç´¹ä»‹ã¨æ´»ç”¨æ–¹æ³•"
emoji: "ğŸ™†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [iOS,Swift,SwiftUI,SwiftData]
published: false
---

![](/images/2024-06-23-21-20-20.png)

![](/images/2024-06-23-21-20-33.png)


![](/images/2024-06-23-21-20-44.png)

![](/images/2024-06-23-21-21-51.png)


![](/images/2024-06-23-21-22-24.png)

![](/images/2024-06-23-21-22-41.png)

![](/images/2024-06-23-21-22-54.png)

![](/images/2024-06-23-21-23-10.png)

![](/images/2024-06-23-21-23-31.png)

![](/images/2024-06-23-21-24-20.png)

![](/images/2024-06-23-21-24-30.png)

![](/images/2024-06-23-21-24-43.png)

![](/images/2024-06-23-21-28-22.png)

![](/images/2024-06-23-21-28-47.png)

![](/images/2024-06-23-21-29-05.png)

![](/images/2024-06-23-21-29-22.png)

![](/images/2024-06-23-21-30-04.png)

![](/images/2024-06-23-21-30-24.png)

![](/images/2024-06-23-21-30-38.png)

![](/images/2024-06-23-21-31-06.png)

![](/images/2024-06-23-21-31-24.png)

![](/images/2024-06-23-21-31-35.png)

![](/images/2024-06-23-21-31-56.png)

![](/images/2024-06-23-21-32-25.png)



äº†è§£ã—ã¾ã—ãŸã€‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¢—ã‚„ã—ã¦ã€ã‚³ãƒ¼ãƒ‰ã®èª¬æ˜ã‚’è©³ã—ãã—ã¾ã™ã€‚

# SwiftDataã®ç´¹ä»‹ã¨æ´»ç”¨æ–¹æ³•

## ã¯ã˜ã‚ã«
ã“ã‚“ã«ã¡ã¯ã€Appleã®SwiftDataãƒãƒ¼ãƒ ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã€Nick Gillettã§ã™ã€‚ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã¯ã€æ–°ã—ã„å¼·åŠ›ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯SwiftDataã‚’æ´»ç”¨ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è©³ã—ãèª¬æ˜ã—ã¾ã™ã€‚ã¾ãšã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®æ°¸ç¶šåŒ–ã®è¨­å®šæ–¹æ³•ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚æ¬¡ã«ã€ModelContextã‚’ä½¿ç”¨ã—ã¦å¤‰æ›´ã‚’è¿½è·¡ã—æ°¸ç¶šåŒ–ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚æœ€å¾Œã«ã€ã‚³ãƒ¼ãƒ‰å†…ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ“ä½œã™ã‚‹éš›ã«SwiftDataã‚’æœ€å¤§é™ã«æ´»ç”¨ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## æ°¸ç¶šåŒ–ã®è¨­å®š
### ãƒ¢ãƒ‡ãƒ«ã®å®šç¾©

SwiftDataã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šåŒ–ã™ã‚‹ãŸã‚ã®åŸºæœ¬å˜ä½ã¨ã—ã¦Modelã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ä»¥ä¸‹ã¯ã€SampleTripsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®Tripã‚¯ãƒ©ã‚¹ã®å®šç¾©ä¾‹ã§ã™ã€‚

```swift
// @Modelã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã€SwiftDataã«æ°¸ç¶šåŒ–ã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™
@Model
final class Trip {
    // æ—…è¡Œã®ç›®çš„åœ°
    var destination: String?
    // æ—…è¡Œã®çµ‚äº†æ—¥
    var end_date: Date?
    // æ—…è¡Œã®åå‰
    var name: String?
    // æ—…è¡Œã®é–‹å§‹æ—¥
    var start_date: Date?
    
    // ãƒã‚±ãƒƒãƒˆãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã¨ã®é–¢ä¿‚ï¼ˆã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤ï¼‰
    @Relationship(.cascade)
    var bucketListItem: [BucketListItem] = [BucketListItem]()
    
    // å®¿æ³Šæ–½è¨­ã¨ã®é–¢ä¿‚ï¼ˆã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤ï¼‰
    @Relationship(.cascade)
    var livingAccommodation: LivingAccommodation?
}
```

### ModelContainerã®åˆæœŸåŒ–

ModelContainerã¯ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ã‚’ç®¡ç†ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€Tripã‚¯ãƒ©ã‚¹ã ã‘ã‚’ä½¿ç”¨ã—ã¦ModelContainerã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™ã€‚

```swift
// Tripã‚¯ãƒ©ã‚¹ã‚’ä½¿ã£ã¦ModelContainerã‚’åˆæœŸåŒ–
let container = try ModelContainer(for: Trip.self)
```

SwiftDataã¯é–¢é€£ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹ã‚‚è‡ªå‹•çš„ã«æ¨è«–ã—ã¾ã™ã€‚

```swift
// è¤‡æ•°ã®ãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã£ã¦ModelContainerã‚’åˆæœŸåŒ–
let container = try ModelContainer(
    for: [
        Trip.self, 
        BucketListItem.self, 
        LivingAccommodation.self
    ]
)
```

### ModelConfigurationã®ä½¿ç”¨

ModelConfigurationã‚’ä½¿ç”¨ã—ã¦ModelContainerã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¤‡æ•°ã®ã‚¹ã‚­ãƒ¼ãƒã¨ãƒ•ã‚¡ã‚¤ãƒ«URLã‚’æŒ‡å®šã—ã¦ModelContainerã‚’ä½œæˆã—ã¾ã™ã€‚

```swift
// å…¨ä½“ã®ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©
let fullSchema = Schema([
    Trip.self,
    BucketListItem.self,
    LivingAccommodations.self,
    Person.self,
    Address.self
])

// Tripé–¢é€£ã®ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–è¨­å®š
let trips = ModelConfiguration(
    schema: Schema([
        Trip.self,
        BucketListItem.self,
        LivingAccommodations.self
    ]),
    url: URL(filePath: "/path/to/trip.store"),
    cloudKitContainerIdentifier: "com.example.trips"
)

// Personé–¢é€£ã®ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–è¨­å®š
let people = ModelConfiguration(
    schema: Schema([Person.self, Address.self]),
    url: URL(filePath: "/path/to/people.store"),
    cloudKitContainerIdentifier: "com.example.people"
) 

// è¤‡æ•°ã®è¨­å®šã‚’ä½¿ã£ã¦ModelContainerã‚’åˆæœŸåŒ–
let container = try ModelContainer(for: fullSchema, trips, people)
```

## SwiftUIã§ã®ModelContainerã®ä½¿ç”¨
SwiftUIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€`modelContainer`ä¿®é£¾å­ã‚’ä½¿ç”¨ã—ã¦ModelContainerã‚’ç°¡å˜ã«ä½œæˆã§ãã¾ã™ã€‚

```swift
@main
struct TripsApp: App {
    var body: some Scene {
        WindowGroup {
            ContentView()
        }
        // modelContainerä¿®é£¾å­ã‚’ä½¿ç”¨ã—ã¦ModelContainerã‚’ä½œæˆ
        .modelContainer(for: Trip.self)
    }
}
```

### ModelContextã®å‚ç…§
SwiftUIã®ãƒ“ãƒ¥ãƒ¼ã§ModelContextã‚’å‚ç…§ã™ã‚‹ä¾‹ã§ã™ã€‚

```swift
struct ContentView: View {
    // Tripã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã‚’ã‚¯ã‚¨ãƒª
    @Query var trips: [Trip]
    // ç’°å¢ƒã‹ã‚‰ModelContextã‚’å–å¾—
    @Environment(\.modelContext) var modelContext
    
    var body: some View {
        NavigationStack {
            List {
                // æ—…è¡Œãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                ForEach(trips) { trip in
                    TripListItem(trip: trip)
                        .swipeActions(edge: .trailing) {
                            Button(role: .destructive) {
                                // ãƒ¢ãƒ‡ãƒ«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æ—…è¡Œã‚’å‰Šé™¤
                                modelContext.delete(trip)
                            } label: {
                                Label("Delete", systemImage: "trash")
                            }
                        }
                }
                .onDelete(perform: deleteTrips(at:))
            }
        }
    }
}
```

## é«˜åº¦ãªæ©Ÿèƒ½
### FetchDescriptorã®ä½¿ç”¨
FetchDescriptorã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã™ã‚‹ä¾‹ã§ã™ã€‚

```swift
// æ–°ã—ã„SwiftContextã‚’ä½œæˆã—ã€Tripã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
let context = self.newSwiftContext(from: Trip.self)
var trips = try context.fetch(FetchDescriptor<Trip>())
```

### Predicateãƒã‚¯ãƒ­ã‚’ä½¿ã£ãŸã‚¯ã‚¨ãƒª

```swift
// æ–°ã—ã„SwiftContextã‚’ä½œæˆ
let context = self.newSwiftContext(from: Trip.self)
// ãƒ›ãƒ†ãƒ«åã®ãƒªã‚¹ãƒˆ
let hotelNames = ["First", "Second", "Third"]

// Predicateãƒã‚¯ãƒ­ã‚’ä½¿ã£ã¦ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã‚’å®šç¾©
var predicate = #Predicate<Trip> { trip in
    trip.livingAccommodations.filter {
        hotelNames.contains($0.placeName)
    }.count > 0
}

// FetchDescriptorã«Predicateã‚’è¨­å®šã—ã¦ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
var descriptor = FetchDescriptor(predicate: predicate)
var trips = try context.fetch(descriptor)
```

### ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®åˆ—æŒ™

```swift
// FetchDescriptorã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ—æŒ™
context.enumerate(FetchDescriptor<Trip>()) { trip in
    // tripã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã—ã¦æ“ä½œã‚’è¡Œã†
}
```

### SortDescriptorã‚’ä½¿ã£ãŸåˆ—æŒ™

```swift
// Predicateãƒã‚¯ãƒ­ã‚’ä½¿ã£ã¦ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã‚’å®šç¾©
let predicate = #Predicate<Trip> { trip in
    trip.bucketListItem.filter {
        $0.hasReservation == false
    }.count > 0
}

// FetchDescriptorã«Predicateã¨SortDescriptorã‚’è¨­å®šã—ã¦ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
let descriptor = FetchDescriptor(predicate: predicate)
descriptor.sortBy = [SortDescriptor(\.start_date)]

// ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ—æŒ™ã—ã¦å‡¦ç†ã‚’å®Ÿè¡Œ
context.enumerate(descriptor) { trip in
    // tripã«å¯¾ã—ã¦ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¨­å®šãªã©ã®æ“ä½œã‚’è¡Œã†
}
```

### ãƒãƒƒãƒã‚µã‚¤ã‚ºã¨allowEscapingMutationsã®èª¿æ•´

```swift
// Predicateãƒã‚¯ãƒ­ã‚’ä½¿ã£ã¦ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã‚’å®šç¾©
let predicate = #Predicate<Trip> { trip in
    trip.bucketListItem.filter {
        $0.hasReservation == false
    }.count > 0
}

// FetchDescriptorã«Predicateã¨SortDescriptorã‚’è¨­å®š
let descriptor = FetchDescriptor(predicate: predicate)
descriptor.sortBy = [SortDescriptor(\.start_date)]

// ãƒãƒƒãƒã‚µã‚¤ã‚ºã¨allowEscapingMutationsã‚’è¨­å®šã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ—æŒ™
context.enumerate(
    descriptor,
    batchSize: 500,
    allowEscapingMutations: true
) { trip in
    // tripã«å¯¾ã—ã¦ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¨­å®šãªã©ã®æ“ä½œã‚’è¡Œã†
}
```

## ã¾ã¨ã‚
ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã¯ã€Schemaã¨ModelConfigurationã‚’ä½¿ç”¨ã—ã¦å¼·åŠ›ãªæ°¸ç¶šåŒ–è¨­å®šã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã—ãŸã€‚ã¾ãŸã€ModelContainerã¨ModelContextã‚’ä½¿ç”¨ã—ã¦æ¨™æº–çš„ãªã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½ã‚’ç°¡å˜ã«æ¡ç”¨ã™ã‚‹æ–¹æ³•ã‚‚ç´¹ä»‹ã—ã¾ã—ãŸã€‚SwiftDataã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€å®‰å…¨ã§é«˜æ€§èƒ½ãªã‚³ãƒ¼ãƒ‰ã‚’ç°¡å˜ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚SwiftDataã®æ–°ã—ã„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã©ã®ã‚ˆã†ã«æ´»ç”¨ã§ãã‚‹ã‹ã‚’æ¥½ã—ã¿ã«ã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸Šã€SwiftDataã®ç´¹ä»‹ã¨æ´»ç”¨æ–¹æ³•ã«ã¤ã„ã¦ã®æŠ€è¡“è¨˜äº‹ã§ã—ãŸã€‚Happy Coding!