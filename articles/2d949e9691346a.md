---
title: "HealthKitã§ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã‚’ç®¡ç†ã™ã‚‹"
emoji: "ğŸ©º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [iOS,Swift,SwiftUI,HealthKit]
published: false
---

# HealthKitã«æ–°ãŸã«è¿½åŠ ã•ã‚ŒãŸãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹APIã®ç´¹ä»‹

Appleã®æœ€æ–°ã®é–‹ç™ºè€…å‘ã‘ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«HealthKitã«æ–°ãŸã«è¿½åŠ ã•ã‚ŒãŸAPIã«ã¤ã„ã¦è©³ã—ãç´¹ä»‹ã•ã‚Œã¾ã—ãŸã€‚

## æ–°ã—ã„ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°æ©Ÿèƒ½ã®ç´¹ä»‹

### ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã®é‡è¦æ€§

ç¾ä»£ç¤¾ä¼šã«ãŠã„ã¦ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã®é‡è¦æ€§ãŒã¾ã™ã¾ã™é«˜ã¾ã£ã¦ã„ã¾ã™ã€‚Appleã¯ã€å°ã•ãªã‚¹ãƒ†ãƒƒãƒ—ãŒãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ã«å¤§ããªå½±éŸ¿ã‚’ä¸ãˆã‚‹ã¨è€ƒãˆã€ç²¾ç¥çš„ãªå¥åº·çŠ¶æ…‹ã‚’è¨˜éŒ²ã—ã‚„ã™ãã™ã‚‹ä¸€é€£ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚Healthã‚¢ãƒ—ãƒªã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªèº«ã®æ°—åˆ†ã‚’æŒ¯ã‚Šè¿”ã‚Šã€ã€Œå¿ƒã®çŠ¶æ…‹ï¼ˆState of Mindï¼‰ã€ã‚’è¨˜éŒ²ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### GAD-7ã¨PHQ-9ã®å°å…¥

![](/images/2024-06-15-21-08-21.png)

GAD-7ã¨PHQ-9ã¯ã€ç²¾ç¥çš„å¥åº·ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã«ä½¿ç”¨ã•ã‚Œã‚‹è©•ä¾¡æ³•ã§ã€GAD-7ã¯ä¸å®‰ãƒªã‚¹ã‚¯ã‚’è©•ä¾¡ã™ã‚‹7ã¤ã®è³ªå•ã€PHQ-9ã¯ã†ã¤ç—…ãƒªã‚¹ã‚¯ã‚’è©•ä¾¡ã™ã‚‹9ã¤ã®è³ªå•ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã‚’HealthKitã§èª­ã¿æ›¸ãã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€æ²»ç™‚ã®æœ‰åŠ¹æ€§ã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸã‚Šã€åŒ»å¸«ã®è¨ºå¯Ÿçµæœã‚’ä¿å­˜ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

### å¿ƒã®çŠ¶æ…‹ï¼ˆState of Mindï¼‰ã®è©³ç´°

![](/images/2024-06-13-05-51-37.png)

å¿ƒã®çŠ¶æ…‹ã¯ã€æ„Ÿæƒ…ã¨æ°—åˆ†ã®ä¸¡æ–¹ã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ã®æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿å‹ã§ã™ã€‚æ„Ÿæƒ…ã¯çŸ­æœŸé–“ã®æ„Ÿè¦šï¼ˆæ•°ç§’ã‹ã‚‰æ•°åˆ†ï¼‰ã€æ°—åˆ†ã¯é•·æœŸé–“ã®æ„Ÿè¦šï¼ˆæ•°æ™‚é–“ã‹ã‚‰æ•°æ—¥ï¼‰ã‚’è¡¨ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®æ„Ÿæƒ…çŠ¶æ…‹ã‚’åæ˜ ã—ã€æ„Ÿæƒ…çš„ãªèªè­˜ã¨å›å¾©åŠ›ã‚’è‚²ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚
æ¥½ã—ã„ã€ä¸å¿«ã€ã©ã¡ã‚‰ã§ã‚‚ãªã„ãªã©ã€æ§˜ã€…ãªæ„Ÿæƒ…ã‚’çµŒé¨“ã™ã‚‹ã“ã¨ã¯æ­£å¸¸ã§ã‚ã‚Šã€å¥åº·çš„ã§ã™ã€‚
å¿ƒã®çŠ¶æ…‹ã‚’è¨˜éŒ²ã™ã‚‹ã“ã¨ã¯ã€é•·æœŸçš„ãªæ„Ÿæƒ…ã®èªè­˜ã¨å›å¾©åŠ›ã‚’ä¿ƒé€²ã•ã›ã¾ã™ã€‚

## APIã®å…·ä½“çš„ãªä½¿ç”¨æ–¹æ³•

### æ–°ã—ã„State of Mind APIã®ä½¿ç”¨ä¾‹

![](/images/2024-06-13-05-56-09.png)

![](/images/2024-06-13-05-56-33.png)

![](/images/2024-06-13-05-57-04.png)

![](/images/2024-06-13-05-57-20.png)

![](/images/2024-06-13-05-57-50.png)

ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã«åŸºã¥ã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ°—åˆ†ã‚’è¨˜éŒ²ã™ã‚‹ã‚¢ãƒ—ãƒªã®é–‹ç™ºã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚çµµæ–‡å­—ã‚’ä½¿ç”¨ã—ã¦æ°—åˆ†ã‚’è¨˜éŒ²ã—ã€HealthKitã«ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªèº«ã®æ„Ÿæƒ…çŠ¶æ…‹ã‚’ç°¡å˜ã«åæ˜ ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚æ–°ã—ã„Predicateã‚’ä½¿ç”¨ã—ã¦ã€ç‰¹å®šã®æ„Ÿæƒ…ã‚„æ°—åˆ†ã‚’ã‚¯ã‚¨ãƒªã™ã‚‹æ–¹æ³•ã‚‚ç´¹ä»‹ã•ã‚Œã¾ã—ãŸã€‚

### å®Ÿè£…

æ–°ã—ã„State of Mind APIã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚¢ãƒ—ãƒªã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ³ã‚¿ãƒ«ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ã«é–¢ã™ã‚‹æ–°ã—ã„æ´å¯Ÿã‚’æä¾›ã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã®è³ªã‚’è©•ä¾¡ã—ãŸã‚Šã€æœ€ã‚‚æ„å‘³ã®ã‚ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç‰¹å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```swift
// State of Mind HealthKitã‚µãƒ³ãƒ—ãƒ«ã®èª­ã¿æ›¸ãã®èªå¯ã‚’è¦æ±‚

import HealthKitUI

func healthDataAccessRequest(
    store: HKHealthStore, 
    shareTypes: Set<HKSampleType>,
    readTypes: Set<HKObjectType>? = nil,
    trigger: some Equatable,
    completion: @escaping (Result<Bool, any Error>) -> Void
) -> some View

```

![](/images/2024-06-13-06-05-12.png)


```swift
// EmojiType

enum EmojiType: CaseIterable {
    case angry
    case sad
    case indifferent
    case satisfied
    case happy
    
    var emoji: String {
        switch self {
        case .angry: return "ğŸ˜¡"
        case .sad: return "ğŸ˜¢"
        case .indifferent: return "ğŸ˜"
        case .satisfied: return "ğŸ˜Œ"
        case .happy: return "ğŸ˜Š"
        }
    }
}

```

```swift
/// ã‚¤ãƒ™ãƒ³ãƒˆã¨çµµæ–‡å­—ã®é¸æŠã«åŸºã¥ã„ãŸState of Mindã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œæˆ

func createSample(for event: EventModel, emojiType: EmojiType) ->
HKStateOfMind {
    let kind: HKStateOfMind.Kind = .momentaryEmotion
    let valence: Double = emojiType.valence
    let label = emojiType.label
    let association = event.association
    return HKStateOfMind(date: event.endDate,
                         kind: kind,
                         valence: valence,
                         labels: [label],
                         associations: [association])
}
```

```swift
// çµµæ–‡å­—ã®é¸æŠã‹ã‚‰State of Mindã‚µãƒ³ãƒ—ãƒ«ã‚’ä¿å­˜

func save(sample: HKSample, healthStore: HKHealthStore) async {
    do {
        try await healthStore.save(sample)
    } catch {
        // ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’ã“ã“ã«è¨˜è¿°
    }
}

```

æ„Ÿæƒ…ã®ãƒ­ã‚°ã‚’æ®‹ã™ã“ã¨ã«ã‚ˆã£ã¦ã€é‹å‹•æ™‚é–“ã€ ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«æ™‚é–“ã€ç¡çœ ãªã©ã€ä»–ã®ãƒ‡ãƒ¼ã‚¿ ã‚¿ã‚¤ãƒ—ã¨ã®æ¯”è¼ƒã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
èª°ã‹ã®æ°—åˆ†ã«åŸºã¥ã„ã¦ãã®äººã®äººç”Ÿã®ç¬é–“ã‚’åˆ‡ã‚Šå–ã‚Šã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸæ´å¯Ÿã‚’æä¾›ã§ãã¾ã™ã€‚

![](/images/2024-06-13-06-16-18.png)

![](/images/2024-06-13-06-16-35.png)

![](/images/2024-06-13-06-16-49.png)

![](/images/2024-06-13-06-17-03.png)

```swift
// State of Mindã‚µãƒ³ãƒ—ãƒ«ã‚’ã‚¯ã‚¨ãƒª

let datePredicate: NSPredicate = { ... }
let associationsPredicate = NSCompoundPredicate (
    orPredicateWithSubpredicates: associations.map {
        HKQuery.predicateForStatesOfMind(with: $0)
    }
)
let compoundPredicate = NSCompoundPredicate(
    andPredicateWithSubpredicates: [datePredicate, associationsPredicate]
)
let stateOfMindPredicate = HKSamplePredicate.stateOfMind(compoundPredicate)

let descriptor = HKSampleQueryDescriptor(predicates: [stateOfMindPredicate],
                                         sortDescriptors: [])
var results: [HKStateOfMind] = []
do {
    // ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦çµæœã‚’å¾…ã¤
    results = try await descriptor.result(for: healthStore)
} catch {
    // ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’ã“ã“ã«è¨˜è¿°
}

// å„valenceå€¤ã‚’0.0ã‹ã‚‰2.0ã®ç¯„å›²ã«èª¿æ•´
let adjustedValenceResults = results.map { $0.valence + 1.0 }
// å¹³å‡valenceã‚’è¨ˆç®—
let totalAdjustedValence = adjustedValenceResults.reduce(0.0, +)
let averageAdjustedValence = totalAdjustedValence / Double(results.count)
// valenceã‚’ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã«å¤‰æ›
let adjustedValenceAsPercent = Int(100.0 * (averageAdjustedValence / 2.0))


```

```swift
// ç‰¹å®šã®ãƒ©ãƒ™ãƒ«ã‚’æŒã¤é–¢é€£ã™ã‚‹State of Mindã‚µãƒ³ãƒ—ãƒ«ã‚’ã‚¯ã‚¨ãƒª
let label: HKStateOfMind.Label = .happy

// ã‚¯ã‚¨ãƒªã‚’è¨­å®š
let datePredicate = HKQuery.predicateForSamples(withStart: dateInterval.start,
                                                end: dateInterval.end)
let associationPredicate = HKQuery.predicateForStatesOfMind(with: association)
let labelPredicate = HKQuery.predicateForStatesOfMind(with: label)
let compoundPredicate = NSCompoundPredicate(
    andPredicateWithSubpredicates: [datePredicate, associationPredicate, labelPredicate]
)
let stateOfMindPredicate = HKSamplePredicate.stateOfMind(compoundPredicate)
let descriptor = HKAnchoredObjectQueryDescriptor(predicates: [stateOfMindPredicate],
                                                 anchor: nil)

// çµæœã‚’å–å¾—
let results = descriptor.results(for: healthStore)
let samples: [HKStateOfMind] = try await results.reduce([]) { $1.addedSamples }

// State of Mindã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
let happiestSample = samples.max { $0.valence < $1.valence }
let happiestEvent: EventModel? = findClosestEvent(startDate: happiestSample?.startDate,
                                                  endDate: happiestSample?.endDate)
```

## ãƒ¡ãƒ³ã‚¿ãƒ«ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ã®é‡è¦æ€§ã¨APIã®å¿œç”¨

ãƒ¡ãƒ³ã‚¿ãƒ«ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ãŒäººç”Ÿã®ã‚ã‚‰ã‚†ã‚‹åˆ†é‡ã§é‡è¦ã§ã‚ã‚‹ã“ã¨ã‚’å¼·èª¿ã—ã¾ã—ãŸã€‚State of Mind APIã¯ã€ç‘æƒ³ã‚„æ—¥è¨˜ãªã©ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«çµ„ã¿è¾¼ã‚€ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¾¡å€¤ã‚ã‚‹æ´å¯Ÿã‚’æä¾›ã™ã‚‹ãŸã‚ã®å¼·åŠ›ãªãƒ„ãƒ¼ãƒ«ã¨ãªã‚Šã¾ã™ã€‚ã¾ãŸã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªèº«ã®æ„Ÿæƒ…çŠ¶æ…‹ã‚’åæ˜ ã—ã€ã‚ˆã‚Šè‰¯ã„ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®æ‰‹åŠ©ã‘ã‚’ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®æ–°ã—ã„APIã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€é–‹ç™ºè€…ã¯ã‚ˆã‚Šãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸä½“é¨“ã‚’æä¾›ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ³ã‚¿ãƒ«ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã‚¢ãƒ—ãƒªã‚’ä½œæˆã§ãã‚‹ã§ã—ã‚‡ã†ã€‚ä»Šå¾Œã‚‚Appleã®HealthKitã«é–¢ã™ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ãªãŒã‚‰ã€ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®å–ã‚Šçµ„ã¿ã‚’ç¶šã‘ã¦ã„ãã“ã¨ãŒæœŸå¾…ã•ã‚Œã¾ã™ã€‚