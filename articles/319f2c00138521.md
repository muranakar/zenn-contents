---
title: "ã€Flutterã€‘SQLiteã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸè¨­å®š"
emoji: "ğŸ´"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Flutter, Dart, SQLite]
published: true
published_at: 2025-01-24 07:00 # æœªæ¥ã®æ—¥æ™‚ã‚’æŒ‡å®šã™ã‚‹
---
## ä½¿ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

https://pub.dev/packages/sqflite

# SQLite ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã¯

SQLite ã¯è»½é‡ã§é«˜æ€§èƒ½ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã€ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒ­ãƒ¼ã‚«ãƒ« DB ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã‚¢ãƒ—ãƒªå†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŠ¹ç‡çš„ã«ä¿å­˜ãƒ»ç®¡ç†ã™ã‚‹ãŸã‚ã«ã€ä½¿ã„æ–¹ã‚’å­¦ã³ã¾ã™ã€‚

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åŸºæœ¬è¨­å®š

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€ã¾ãšã‚¢ãƒ—ãƒªå†…ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€é©åˆ‡ãªå ´æ‰€ã«ä¿å­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚Android ã¨ iOS ã§ã¯ä¿å­˜å ´æ‰€ãŒç•°ãªã‚Šã¾ã™ãŒã€`getDatabasesPath()`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«é©ã—ãŸå ´æ‰€ã‚’è‡ªå‹•çš„ã«å–å¾—ã§ãã¾ã™ã€‚

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å ´æ‰€ã‚’è¨­å®šã™ã‚‹

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹å‰ã«ã€ä¿å­˜å…ˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚å­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆã—ã¾ã™ã€‚

```dart
// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä¿å­˜å ´æ‰€ã‚’å–å¾—
var databasesPath = await getDatabasesPath();
var path = join(databasesPath, 'myapp.db');

// ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
try {
  await Directory(databasesPath).create(recursive: true);
} catch (_) {}
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‹ã

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‹ãæ–¹æ³•ã¯è¤‡æ•°ã‚ã‚Šã¾ã™ã€‚æœ€ã‚‚åŸºæœ¬çš„ãªæ–¹æ³•ã¯`openDatabase`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™ãŒã€å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãªã©ã€ç‰¹åˆ¥ãªè¨­å®šãŒå¿…è¦ãªå ´åˆã¯`onConfigure`ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```dart
// åŸºæœ¬çš„ãªé–‹ãæ–¹
var db = await openDatabase('myapp.db');

// å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’æœ‰åŠ¹ã«ã™ã‚‹å ´åˆ
Future<void> _onConfigure(Database db) async {
  await db.execute("PRAGMA foreign_keys = ON");
}

var db = await openDatabase(
  path,
  onConfigure: _onConfigure
);
```

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸè¨­å®šã¨ãƒ‡ãƒ¼ã‚¿æŠ•å…¥

æ–°ã—ããƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹éš›ã¯ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆã¨åˆæœŸãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥ãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã‚‰ã®å‡¦ç†ã¯`onCreate`ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§è¡Œã„ã¾ã™ã€‚

### ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã¨åˆæœŸãƒ‡ãƒ¼ã‚¿

ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã€ãƒ†ã‚¹ãƒˆç”¨ã®åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¦ã„ã¾ã™ã€‚

```dart
// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆæ™‚ã®å‡¦ç†
Future<void> _onCreate(Database db, int version) async {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
  await db.execute('''
    CREATE TABLE Users (
      id INTEGER PRIMARY KEY,
      name TEXT,
      email TEXT
    )
  ''');

  // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
  await db.insert('Users', {
    'name': 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
    'email': 'test@example.com'
  });
}

var db = await openDatabase(
  path,
  version: 1,
  onCreate: _onCreate
);
```

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é€²åŒ–ã«ä¼´ã„ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ§‹é€ ã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒå‡ºã¦ãã¾ã™ã€‚ã“ã®ã‚ˆã†ãªå¤‰æ›´ã‚’å®‰å…¨ã«è¡Œã†ãŸã‚ã«ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã®ä»•çµ„ã¿

```mermaid
graph TD
    A[ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚ªãƒ¼ãƒ—ãƒ³] --> B{ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å­˜åœ¨?}
    B -->|No| C[onCreateå®Ÿè¡Œ]
    B -->|Yes| D{æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ï¼ ç¾ãƒãƒ¼ã‚¸ãƒ§ãƒ³}
    D -->|Yes| E[onUpgradeå®Ÿè¡Œ]
    D -->|No| F{æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ï¼œ ç¾ãƒãƒ¼ã‚¸ãƒ§ãƒ³}
    F -->|Yes| G[onDowngradeå®Ÿè¡Œ]
```

### ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã®å‡¦ç†

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ§‹é€ ã‚’å¤‰æ›´ã™ã‚‹éš›ã¯ã€å¿…ãšãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’ä¸Šã’ã€`onUpgrade`ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å¤‰æ›´å†…å®¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```dart
Future<void> _onUpgrade(Database db, int oldVersion, int newVersion) async {
  if (oldVersion < 2) {
    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³2ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ–°ã—ã„åˆ—ã‚’è¿½åŠ 
    await db.execute('ALTER TABLE Users ADD age INTEGER');
  }
}

var db = await openDatabase(
  path,
  version: 2,
  onCreate: _onCreate,
  onUpgrade: _onUpgrade
);
```

## å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ“ä½œã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã«å¤§ããå½±éŸ¿ã—ã¾ã™ã€‚ãã®ãŸã‚ã€é©åˆ‡ãªå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

### ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²ãã€åŠ¹ç‡çš„ãªç®¡ç†ã‚’è¡Œã†ãŸã‚ã«ã€ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```dart
class DatabaseHelper {
  static final DatabaseHelper instance = DatabaseHelper._();
  static Database _database;

  DatabaseHelper._();

  Future<Database> get database async {
    _database ??= await _initDatabase();
    return _database;
  }

  Future<Database> _initDatabase() async {
    var path = await getDatabasesPath();
    return await openDatabase(
      join(path, 'myapp.db'),
      version: 1,
      onCreate: _onCreate
    );
  }
}
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã§ã¯æ§˜ã€…ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä¸»ãªã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã¨ãã®å¯¾ç­–ã‚’èª¬æ˜ã—ã¾ã™ã€‚

### ã‚¨ãƒ©ãƒ¼å¯¾ç­–ã‚³ãƒ¼ãƒ‰ä¾‹

```dart
Future<Database> safeOpenDatabase(String path) async {
  try {
    // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå­˜åœ¨ç¢ºèª
    var dir = Directory(dirname(path));
    if (!await dir.exists()) {
      await dir.create(recursive: true);
    }

    return await openDatabase(
      path,
      version: 1,
      onCreate: _onCreate,
      onOpen: (db) async {
        print('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${await db.getVersion()}');
      }
    );
  } catch (e) {
    print('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚ªãƒ¼ãƒ—ãƒ³ã‚¨ãƒ©ãƒ¼: $e');
    rethrow;
  }
}
```

### é‡è¦ãªæ³¨æ„ç‚¹

1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ä¸€åº¦ã ã‘é–‹ã
2. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã¯å¸¸ã«å¢—åŠ ã™ã‚‹æ–¹å‘ã§è¡Œã†
3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’é©åˆ‡ã«å®Ÿè£…ã™ã‚‹
4. ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã®å¤‰æ›´ã¯æ…é‡ã«è¡Œã†

## å‚ç…§

https://github.com/tekartik/sqflite/blob/master/sqflite/doc/opening_db.md
