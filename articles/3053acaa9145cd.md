---
title: "ã€iOSã€‘HealthKitã§ã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ–¹æ³•"
emoji: "ğŸ©º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [iOS,Swift,SwiftUI,HealthKit]
published: false
---

# HealthKitã¨ã¯

HealthKitã¨ã¯ã€AppleãŒé–‹ç™ºã—ãŸiOSãƒ‡ãƒã‚¤ã‚¹å‘ã‘ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ã¨ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ã¦ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚HealthKitã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ§˜ã€…ãªå¥åº·ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡æ•°ã®ãƒ‡ãƒã‚¤ã‚¹ã§ä¸€å…ƒç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€èº«é•·ãƒ»ä½“é‡ãƒ»æ­©å¹…ãƒ»ç¡çœ etcã®èº«ä½“ã«ã¾ã¤ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![HeathKitæ¦‚è¦](https://storage.googleapis.com/zenn-user-upload/b6ef2aa6c563-20240501.png =400x)

HealthKitã¯ã€ãƒ¦ãƒ¼ã‚¶ã®ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ï¼‘ã¤ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã¾ã¨ã‚ã‚‹æ çµ„ã¿ã§ã™ã€‚ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿æ›¸ããŒã§ãã€ãƒ‡ãƒ¼ã‚¿ã¯ã™ã¹ã¦å®‰å…¨ã«æ ¼ç´ã•ã‚Œã€ãƒ‡ãƒã‚¤ã‚¹é–“ã§åŒæœŸã•ã‚Œã¾ã™

## HealthKitã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

HealthKitã‚’ç”¨ã„ã‚‹ãŸã‚ã«ã¯å¿…è¦ãªå·¥ç¨‹ãŒï¼“ã‚¹ãƒ†ãƒƒãƒ—ã‚ã‚Šã¾ã™ã€‚

1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã§HealthKitæ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹
2. ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãŒHealthKitã«å¯¾å¿œã—ã¦ã„ã‚‹ã‹ç¢ºèªã‚’ã™ã‚‹
3. HKHealthStoreã‚’ä½œæˆã™ã‚‹
4. ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹

### 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã§HealthKitæ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹

ã¾ãšæœ€åˆã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç«‹ã¡ä¸Šã’ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã«Healthkitã‚’å°å…¥ã™ã‚‹ãŸã‚ã«ä»¥ä¸‹ã®æ‰‹é †ã‚’è¡Œã„ã¾ã™ã€‚

1. **Target**ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’é¸æŠ
2. **Capability**ã‚’é¸æŠ

![capabilityã‚’é¸æŠ](https://storage.googleapis.com/zenn-user-upload/3944f0273626-20240501.png)

3. **HealthKit**ã‚’è¿½åŠ 

![HealthKitã‚’é¸æŠ](https://storage.googleapis.com/zenn-user-upload/da6f83446750-20240501.png)

### 2. ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãŒHealthKitã«å¯¾å¿œã—ã¦ã„ã‚‹ã‹ç¢ºèªã‚’ã™ã‚‹

ä¸€ã¤ã®ã‚¢ãƒ—ãƒªã‚’è¤‡æ•°ã®ãƒ‡ãƒã‚¤ã‚¹ã§èµ·å‹•ã•ã›ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã§ã™ãŒã€ãã®éš›ã«ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ãŸãƒ‡ãƒã‚¤ã‚¹ãŒHealthKitã«å¯¾å¿œã—ã¦ã„ãªã„å ´åˆãŒã‚ã‚‹ãŸã‚ã€å¯¾å¿œã—ã¦ã„ã‚‹ã‹ç¢ºèªã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

https://github.com/muranakar/HealthKitSample/blob/main/HealthKitSample/Utilities/HealthData.swift#L53-L55

### 3. HKHealthStoreã‚’ä½œæˆã™ã‚‹

`HKHealthStore`ãŒãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ãƒ‡ãƒ¼ã‚¿ã«æ¥ç¶šã™ã‚‹å…¥å£ã¨ãªã‚‹éƒ¨åˆ†ã§ã™ã€‚`HKHealthStore`ã‚’ç”¨ã„ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ä»¥ä¸‹ã®é …ç›®ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’æ±‚ã‚ã‚‹
- ã‚¯ã‚¨ãƒªã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿æ›¸ããŒã§ãã‚‹
- ä¸€åº¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆã™ã‚Œã°ã€ã‚¢ãƒ—ãƒªå†…ã§`HKHealthStore`ã‚’ä½¿ç”¨ã§ãã‚‹

HealthKitã‚’ç”¨ã„ã‚‹ä¸Šã§ã€HealthKitã§ç”¨ã„ã‚‰ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿å‹ãƒ»é–¢ä¿‚æ€§ã‚’ç†è§£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚ãŸã‚Šã‚’ç†è§£ã•ã‚Œã¦ã„ãªã„æ–¹ã¯ã€ä»¥ä¸‹ãƒªãƒ³ã‚¯ã‚’ä¸€èª­ã„ãŸã ããŸã„ã§ã™ã€‚

https://zenn.dev/muranaka/articles/4dd3fbda1fecb2

### 4.ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹

ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã«ã¯å¿…è¦ãªãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ãƒ‡ãƒ¼ã‚¿ã®ç¨®é¡ã‚’æŒ‡å®šã—ã¦ã€ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’è¦æ±‚ã—ã¾ã™ã€‚ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã¯ã€ã€Œèª­ã¿è¾¼ã¿ã€ã¨ã€Œæ›¸ãè¾¼ã¿ã€ã«åˆ†ã‹ã‚Œã¦ãŠã‚Šã€æ¨©é™ã®è¨±å¯ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã™ã‚‹ä¸Šã§ã€æ¨©é™ã®è¨±å¯ãŒå¿…è¦ã§ã‚ã‚‹ã“ã¨ã‚’èª¬æ˜ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’æ±‚ã‚ã‚‹ã¨ã€HealthKitã®æ¨©é™ã®è¨­å®šã‚’è¡Œã†ViewãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

info.plistã§Keyã‚’ï¼’ã¤å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

- **Privacy - Health Update Usage Description**
  `NSHealthUpdateUsageDescription`
  
- **Privacy - Health Share Usage Description**
  `NSHealthShareUsageDescription`
  
ä¸‹ç”»åƒã®ä¸Šèµ¤æ ãŒæ›¸ãè¾¼ã¿æ¨©é™ã«ã¤ã„ã¦ã€ä¸‹èµ¤æ ãŒèª­ã¿è¾¼ã¿æ¨©é™ã«ã¤ã„ã¦è¨˜è¼‰ãŒåæ˜ ã•ã‚Œã¾ã™ã€‚

![æ¨©é™ã‚·ãƒ¼ãƒˆç”»åƒ](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/799713/459ace11-1e53-4557-78c3-d817a96d1d3a.png =400x)

:::message
HealthKitã®å…¨ã¦ã®ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã¨100ç‚¹ä»¥ä¸Šå­˜åœ¨ã™ã‚‹ãŸã‚ã€å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ã¿æ¨©é™ã‚’æ±‚ã‚ã¾ã™ã€‚
:::
æ¨©é™æƒ…å ±ã®ç®¡ç†ã¯HealthKitå†…ã«ä¿å­˜ã•ã‚Œã¦ãŠã‚Šã€ãƒ¦ãƒ¼ã‚¶-ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¤–ã§æ¨©é™æƒ…å ±ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

## ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã‚’è¡Œã†ãŸã‚ã®æ‰‹é †

ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚’è¡Œã†ãŸã‚ã®å®Ÿè£…æ‰‹é †ã¯ï¼“ã¤ã‚ã‚Šã¾ã™ã€‚

1. ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
2. æ­©è¡Œè·é›¢ãªã©ã®ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿ã®Sampleã‚’ä½œæˆã™ã‚‹
3. ä½œæˆã—ãŸSampleã‚’HealthKitã¸ä¿å­˜ã™ã‚‹

ä¸€ã¤ãšã¤èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚

### 1. ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

HealthKitStoreã«ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’è¦æ±‚ã™ã‚‹ã«ã¯ã€[`requestAuthorization(toShare:read:)`](https://developer.apple.com/documentation/healthkit/hkhealthstore/1614152-requestauthorization)ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

https://github.com/muranakar/HealthKitSample/blob/main/HealthKitSample/Utilities/HealthData.swift#L46

SwiftUIã®å ´åˆã¯ã€[`healthDataAccessRequest(store:shareTypes:readTypes:trigger:completion:)`](https://developer.apple.com/documentation/swiftui/view/healthdataaccessrequest(store:sharetypes:readtypes:trigger:completion:))ã‚’ç”¨ã„ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://github.com/muranakar/HealthKitSample/blob/main/HealthKitSample/View/StepCountSaveView.swift#L50-L64

:::message
`healthDataAccessRequest(store:shareTypes:readTypes:trigger:completion:)`ã¯SwiftUIã¨HealthKitUIã®ä¸¡æ–¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹å ´åˆã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚
:::

### 2.æ­©æ•°ã®ãƒ‡ãƒ¼ã‚¿ã®Sampleã‚’ä½œæˆã™ã‚‹

Sampleã¯è¤‡æ•°ãŒå­˜åœ¨ã—ã¦ãŠã‚Šã€`HKQuantitySample`ã«ç€ç›®ã—ã¦è¨˜è¼‰ã—ã¾ã™ã€‚ä»–ã®SampleãŒæ°—ã«ã‚ã‚‹æ–¹ã¯[`HKSampleType`](https://developer.apple.com/documentation/healthkit/hksampletype)ã‚’ã”è¦§ãã ã•ã„ã€‚

#### HKQuantitySampleã¨ã¯ï¼Ÿ

å®šé‡çš„ãªå°ºåº¦ã§ã€å€¤ã®ä¿å­˜ãŒå¯èƒ½ãªãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨ã„ã‚‹éš›ã«ä½¿ç”¨ã™ã‚‹Sampleã§ã™ã€‚
ä¾‹ã¨ã—ã¦ã¯ã€æ­©æ•°ãƒ»æ­©è¡Œè·é›¢ãƒ»å¿ƒæ‹æ•°ãªã©ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

`HKQuantitySample`ã‚’ä½¿ç”¨ã™ã‚‹éš›ã«ã¯ã€ä»¥ä¸‹ã®é …ç›®ã‚’æŒ‡å®šã—ã¾ã™ã€‚

- **ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿é …ç›®**
- **æ•°å€¤**
- **å˜ä½**
- **æ™‚é–“**

##### ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿é …ç›®

`HKQuantitySample`ã‚’ç”¨ã„ã‚‹éš›ã¯ã©ã®ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®éš›ã«ã€`HKQuantityTypeIdentifier`ã‚’ç”¨ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®`stepCount`ï¼ˆæ­©æ•°ï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```swift
static let stepCount: HKQuantityTypeIdentifier
```

##### å˜ä½

å˜ä½ã‚’æŒ‡å®šã™ã‚‹éš›ã¯ã€`HKUnit`ã‚’ç”¨ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
`HKUnit`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€

- é‡ã•ã®å ´åˆã¯ã€ã‚°ãƒ©ãƒ ã€€orã€€ãƒãƒ³ãƒ‰ã€€etc
- é•·ã•ã®å ´åˆã¯ã€ãƒ¡ãƒ¼ã‚¿ãƒ¼ã€€orã€€ã‚¤ãƒ³ãƒ etc

å˜ä½ã«å¿œã˜ãŸå€¤ã‚’ä¿å­˜ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

##### æ•°å€¤ãƒ»æ™‚é–“

æ•°å€¤ã¯`Double`å‹ã€æ™‚é–“ã¯`Date`å‹ã§æ‰±ã„ã¾ã™ã€‚

https://github.com/muranakar/HealthKitSample/blob/main/HealthKitSample/View/StepCountSaveView.swift#L37

è©³ç´°ã®å®Ÿè£…æ–¹æ³•ã«é–¢ã—ã¦ã¯ã€GitHubã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã”è¦§ãã ã•ã„ã€‚

### 3.Sampleã‚’HealthKitã¸ä¿å­˜ã™ã‚‹

`HealthStore`ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨ã„ã¦ä¿å­˜ã‚’è¡Œã†ã€‚ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¯ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã¨Swift Concurrencyï¼ˆasync/awaitï¼‰ã«å¯¾å¿œã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€ã©ã¡ã‚‰ã‚’ç”¨ã„ã¦ã‚‚è‰¯ã„ã§ã™ã€‚

- ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°

```swift
func save(
    _ object: HKObject,
    withCompletion completion: @escaping (Bool, (any Error)?) -> Void
)
```

- Swift Concurrencyï¼ˆasync/awaitï¼‰ã«å¯¾å¿œã—ãŸãƒ¡ã‚½ãƒƒãƒ‰
  
```swift
func save(_ object: HKObject) async throws
```

ä¸Šè¨˜ã®ãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã«ã€`2.æ­©æ•°ã®ãƒ‡ãƒ¼ã‚¿ã®Sampleã‚’ä½œæˆã™ã‚‹`ã§ä½œæˆã—ãŸSampleã‚’æŒ¿å…¥ã—ã€ä¿å­˜ã‚’å®Ÿè¡Œã™ã‚‹ã€‚ä»Šå›ã¯ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’ç”¨ã„ã¦å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

https://github.com/muranakar/HealthKitSample/blob/main/HealthKitSample/View/StepCountSaveView.swift#L38-L47

:::message

- æ¨©é™ã‚’è¦æ±‚ã—ã¦ã„ãªã„çŠ¶æ³ã§ã€ä¿å­˜ã—ã‚ˆã†ã¨ã™ã‚‹ã¨
`HKError.Code.errorAuthorizationNotDetermined`
ã®ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã§å¤±æ•—ã—ã¾ã™ã€‚

- æ¨©é™ã‚’æ‹’å¦ã•ã‚ŒãŸçŠ¶æ³ã§ã€ä¿å­˜ã—ã‚ˆã†ã¨ã™ã‚‹ã¨
`HKError.Code.errorAuthorizationDenied`ã®
ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã§å¤±æ•—ã—ã¾ã™ã€‚

:::

ä»¥ä¸ŠãŒHealthKitã‚’ç”¨ã„ãŸãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜æ–¹æ³•ã«ãªã‚Šã¾ã™ã€‚

## æœ€å¾Œã«

è¨˜äº‹å†…ã«é–“é•ã„ãƒ»æ°—ã«ãªã‚‹éƒ¨åˆ†ã‚ã‚Šã¾ã—ãŸã‚‰ã€ã‚³ãƒ¡ãƒ³ãƒˆã„ãŸã ã‘ã‚‹ã¨å¤§å¤‰ã†ã‚Œã—ã„ã§ã™ã€‚
è‰¯ã‹ã£ãŸã¨æ€ã£ãŸã‚‰ã€è¨˜äº‹ã¸ã®ã„ã„ã­ãƒ»Xã®ãƒ•ã‚©ãƒ­ãƒ¼ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

https://sites.google.com/view/muranakar

å€‹äººã§ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚è‰¯ã‹ã£ãŸã‚‰è¦—ã„ã¦ã¿ã¦ãã ã•ã„ã€‚

## å‚è€ƒURL

https://developer.apple.com/videos/play/wwdc2020/10664/

https://developer.apple.com/documentation/healthkit/hkquantitytypeidentifier

https://developer.apple.com/documentation/healthkit/hkquantitytype

https://developer.apple.com/documentation/healthkit/hkunit
